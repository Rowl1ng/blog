
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">
    <head>
        <meta content='肺部结节检测 - Rowl1ng|黑客与画家' name='title' />
        <meta content='肺部结节检测 - Rowl1ng|黑客与画家' name='og:title' />
        <title>肺部结节检测 - Rowl1ng|黑客与画家</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>肺部结节检测 - Rowl1ng|黑客与画家</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="肺部结节检测 - Rowl1ng|黑客与画家">
<meta name="twitter:keywords"  content="前情提要阿里云天池医疗AI大赛[第一季]：肺部结节智能诊断：由大赛官方提供真实场景下患者肺部CT图像，目标是设计了两个网络，分别负责检测肺部结节的候选区域和判断候选区域是否为真结节，总排名64/2887。Basics  origin：..." property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="肺部结节检测 - Rowl1ng|黑客与画家">
<meta property="og:description" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="og:keywords"  content="前情提要阿里云天池医疗AI大赛[第一季]：肺部结节智能诊断：由大赛官方提供真实场景下患者肺部CT图像，目标是设计了两个网络，分别负责检测肺部结节的候选区域和判断候选区域是否为真结节，总排名64/2887。Basics  origin：..." property='og:description' />
<meta name="theme-Jekyll by Rowl1ng" content="#eb5055">
<link rel="icon" type="image/png" href="http://localhost:4000/style/favicons/favicon.ico" />
<link href="http://localhost:4000/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="http://localhost:4000/">
<link rel="alternate" type="application/rss+xml" title="Rowl1ng" href="http://localhost:4000/feed.xml">
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="http://localhost:4000/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords"  content="前情提要阿里云天池医疗AI大赛[第一季]：肺部结节智能诊断：由大赛官方提供真实场景下患者肺部CT图像，目标是设计了两个网络，分别负责检测肺部结节的候选区域和判断候选区域是否为真结节，总排名64/2887。Basics  origin：..." property='og:description' />
<meta name="description" content="nothing is more practicla than a good theory" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">

<link href="http://localhost:4000/style/style-rowl1ng.css" rel="stylesheet">

    <meta content='http://localhost:4000/%E6%8A%80%E6%9C%AF/luna.html' property='og:url' />
    <meta content="天池肺部结节检测大赛的一点小经验" property='og:description' />
    <meta content="article" property="og:type" />


    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-71226909-1', 'auto');
        ga('send', 'pageview');
    </script>

    </head>
    <body class="" gtools_scp_screen_capture_injected="true">
        <header id="header" class="header bg-white">
            <div class="navbar-container">
                <a href="/?rowl1ng" title="访问 Rowl1ng|黑客与画家" class="navbar-logo"> <img src="http://localhost:4000/style/images/logo-rowl1ng.png" alt="Rowl1ng|黑客与画家"> </a>
                <div class="navbar-menu">
                    
                        <a href="http://localhost:4000/tech">技术</a>
                    
                        <a href="http://localhost:4000/art">艺术</a>
                    
                        <a href="http://localhost:4000/book">读书</a>
                    
                        <a href="http://localhost:4000/write">写作</a>
                    
                        <a href="http://localhost:4000/archives">归档</a>
                    
                        <a href="http://localhost:4000/tags">标签</a>
                    
                        <a href="http://localhost:4000/about">关于</a>
                    
                </div>
                <div class="navbar-search" onclick="">
                    <span class="icon-search"></span>
                    <form id="cb-search-btn" role="search">
                        <span class="search-box">
                             <input type="text" class="input" id="cb-search-content" required="true" placeholder="标题 标签..." maxlength="30" autocomplete="off">
                        </span>
                    </form>
                </div>
                <div class="navbar-mobile-menu" onclick="">
                    <span class="icon-menu cross"><span class="middle"></span></span>
                    <ul>
                        
                            <li><a href="http://localhost:4000/tech">技术</a></li>
                        
                            <li><a href="http://localhost:4000/art">艺术</a></li>
                        
                            <li><a href="http://localhost:4000/book">读书</a></li>
                        
                            <li><a href="http://localhost:4000/write">写作</a></li>
                        
                            <li><a href="http://localhost:4000/archives">归档</a></li>
                        
                            <li><a href="http://localhost:4000/tags">标签</a></li>
                        
                            <li><a href="http://localhost:4000/about">关于</a></li>
                        
                    </ul>
                </div>
            </div>
        </header>
        <div class="post-header-thumb bg-white}">
            <div class="post-header-thumb-op"></div>
            <div class="post-header-thumb">
                <div class="post-header-thumb-container">
                    <h1 class="post-title" itemprop="name headline">
                        肺部结节检测</h1>
                    <div class="post-data">
                        <time datetime="2017-04-25 19:04:00" itemprop="datePublished">发布时间：2017-04-25 19:04:00</time>
                        <a href="/tags#技术" title="访问 技术" data-hover="博客分类: 技术">博客分类: 技术</a>
                        <a href="#read"> 阅读次数: comments</a>
                    </div>
                    <div class="post-tags">
                        
                            
                            
                                
                                <a href="/tags#医疗图像" title="访问医疗图像" data-hover="医疗图像">
                                    医疗图像 <span>(1)</span>
                                    
                                </a>
                                
                            
                            
                        
                    </div>
                </div>
            </div>
        </div>
        <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
            <div class="post-header">
                <h1 class="post-title" itemprop="name headline">
                    肺部结节检测</h1>
                <div class="post-data">
                    <time datetime="2017-04-25 19:04:00" itemprop="datePublished">2017-04-25 19:04:00</time>
                </div>
            </div>
            <div id="post-content" class="post-content" itemprop="articleBody">
                <p class="post-tags">
                    
                        
                        
                            
                                <a href="/tags#医疗图像" title="访问医疗图像" data-hover="医疗图像">
                                    医疗图像 <span>(1)</span>
                                    
                                </a>
                            
                        
                        
                    
                </p>
                <h2 id="前情提要">前情提要</h2>

<p>阿里云天池医疗AI大赛[第一季]：肺部结节智能诊断：由大赛官方提供真实场景下患者肺部CT图像，目标是设计了两个网络，分别负责检测肺部结节的候选区域和判断候选区域是否为真结节，总排名64/2887。</p>

<h2 id="basics">Basics</h2>

<ul>
  <li><code class="highlighter-rouge">origin</code>：表示CT图像最边缘的坐标</li>
  <li><code class="highlighter-rouge">sapcing</code>：真实世界和像素的比例关系</li>
</ul>

<p><img src="http://upload-images.jianshu.io/upload_images/1156558-a483ffcb4ca3d4ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="此处输入图片的描述" /></p>

<h2 id="segmentation">Segmentation</h2>

<h2 id="classification-stagefalse-positive--reduction">Classification Stage(False Positive  Reduction)</h2>
<p>找結節中心
maximum divergence normalized gradient
data augmentation: zoom, rotation, translation</p>

<h3 id="merge-candidates">Merge Candidates</h3>
<p>先腐蚀，再算连通性，再取label，每个label代表一个candidate，取mass中心，存储为csv
对照annotations.csv得到每个candidate的是TP还是FP的label，得到新的csv（最后一列为true/false的标记）
欧式距离</p>
<h3 id="预处理">预处理</h3>

<ul>
  <li>统一spacing到0.5x0.5x0.5mm，也就是说96x96的patch对应现实中48x48mmm</li>
  <li>取三个轴向的切面(patch)，根据candidate的label存储在true/false文件夹下</li>
</ul>

<h4 id="balance">balance</h4>

<ul>
  <li>weighted loss function</li>
  <li>10-foldcross validation：划分为10个</li>
</ul>

<h2 id="评价指标froc曲线">评价指标：FROC曲线</h2>

<p>先来回顾一下精确率（precision）和召回率（recall）：</p>

<p>实际上非常简单，精确率是针对我们预测结果而言的，它表示的是预测为正的样本中有多少是真正的正样本。那么预测为正就有两种可能了，一种就是把正类预测为正类(TP)，另一种就是把负类预测为正类(FP)，也就是
<script type="math/tex">\frac {TP}{TP+FP}</script>
而召回率是针对我们原来的样本而言的，它表示的是样本中的正例有多少被预测正确了。那也有两种可能，一种是把原来的正类预测成正类(TP)，另一种就是把原来的正类预测为负类(FN)。
<script type="math/tex">\frac {TP}{TP+FN}</script>
<img src="http://static.zybuluo.com/sixijinling/19kbgb66gbhj9yzropa03qm7/tp.png" alt="此处输入图片的描述" /></p>

<p>FROC曲线（Free-response ROC）要从<a href="https://zh.m.wikipedia.org/wiki/%E9%9D%88%E6%95%8F%E5%BA%A6%E5%92%8C%E7%89%B9%E7%95%B0%E5%BA%A6">ROC曲线</a>说起，和我们常用的accuracy和recall也可以联系起来看。主要是为了平衡两者：</p>

<ul>
  <li>TPR（True Positive Rate）/ <strong>灵敏度</strong> （Sensitivity） :在所有真的得了癌症的人中，我们要尽最大努力把这些病人都找出来，等同于正例的召回率。
    <ul>
      <li>所有 test
scans 中检测到的真结节的比例： TP/n 其中n是所有scans中真结节的总数, so n = 207 in this stud
<script type="math/tex">\frac {TP}{TP+FN}</script></li>
    </ul>
  </li>
  <li>FPR（False Positive Rate）/(1 - Specificity)：在所有健康人中，我们要尽最大努力<strong>避免误判</strong>成癌症患者，或者说，是尽最大努力把这些健康人都找出来，等同于反例的召回率。
    <ul>
      <li>FP/m 其中m是scans的总数。 so m = 50 in this study <script type="math/tex">\frac{FP}{FP+TN}</script></li>
    </ul>
  </li>
</ul>

<p>这样每一个decision threshhold，都有各自的TP、TN、FP、FN，都对应着曲线上的一个点</p>

<p><a href="https://luna16.grand-challenge.org/evaluation/">Luna官方说明</a>：The evaluation is performed by measuring the detection sensitivity of the algorithm and the corresponding false positive rate per scan.</p>
<ul>
  <li>TP判定（hit criterion）：candidate必须是在standard reference 中以nodule center为中心的半径R（结节直径除2）之内。hit到一个正例之后就将这个例子从表中除去，保证不重复计数。也就是说，又有第二个预测点hit到这个结节时就被忽略，不算TP。</li>
  <li>FP判定：在设定的半径距离内没有hit到任何reference结节.</li>
  <li>忽略的情况：Candidates that are detecting irrelevant findings (see Data section in this page for definition) are ignored during the evaluation and are not considered either false positives or true positives.</li>
</ul>

<p>最终的分数是取7个横座标点对应的纵座标（TPR）均值：</p>

<ul>
  <li>横座标（FPR）： 1/8, 1/4, 1/2, 1, 2, 4, and 8 FPs per scan</li>
  <li>完美是1，最低是0. Most CAD systems in clinical use today have their internal threshold set to operate somewhere between 1 to 4 false positives per scan on average. Some systems allow the user to vary the threshold. To make the task more challenging, we included low false positive rates in our evaluation. This determines if a system can also identify a significant percentage of nodules with very few false alarms, as might be needed for CAD algorithms that operate more or less autonomously.</li>
</ul>

<h3 id="论文里关于froc的说明">论文里关于FROC的说明：</h3>

<p>sensitivity是关于FPR平均值的函数：</p>

<p>This means that the sensitivity (y) is plotted as a function of the average number of false positive markers per scan ().</p>

<ul>
  <li>计算FROC曲线：阈值为t，概率p≥ t则判定为结节，由此计算TPR、FPR，得到曲线上的一个点。</li>
  <li>图像ID号（seriesuid）：发现结果所在的scan的名字。</li>
  <li>三维坐标：浮点数（用小数点，不要用逗号）。注意：我们提供的数据的第一个体素（voxel） 的坐标是 (-128.6,-175.3,-298.3). Coordinates are given in world coordinates or millimeters. You can verify if you use the correct way of addressing voxels by checking the supplied coordinates for the example data, the locations should refer to locations that hold a nodule.</li>
  <li>probability : 描述为真结节的可疑程度，浮点数。通过调节对它设定的<strong>阈值</strong>来计算 <strong>FROC曲线</strong>。</li>
</ul>

<p>Between the strings and the numbers should be a comma character. The order of the lines is irrelevant.</p>

<p>The following is an example result file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seriesuid,coordX,coordY,coordZ,probability
LKDS_00001,75.5,56.0,-194.254518072,6.5243e-05
LKDS_00002,-35.5999634723,78.000078755,-13.3814265714,0.00269234
LKDS_00003,80.2837837838,198.881575673,-572.700012,0.00186072
LKDS_00004,-98.8499883785,33.6429184312,-99.7736607907,0.00035473
LKDS_00005,98.0667072477,-46.4666486536,-141.421980179,0.000256219

</code></pre></div></div>
<p>This file contains 8 findings (obviously way too few). There are 5 unique likelihood values. This means that there will be 5 unique thresholds that produce a distinct set of findings (each threshold discards finding below the threshold. That means there will be 5 points on the FROC curve.</p>

<p>It has to be noted that for the ‘false positive reduction’ challenge track, 551,065 findings (the amount of given candidates) are expected. The order of the lines is irrelevant.</p>

<h2 id="3d-conv">3d conv</h2>

<p><a href="https://www.kaggle.com/c/data-science-bowl-2017/details/tutorial">U-Net Segmentation Approach to Cancer Diagnosis</a>
在luna上的3dconv的unet实现：<a href="https://github.com/Wrosinski/Kaggle-DSB/blob/master/LUNA/models/U-Net%203D/3DUNet_train_generator.py">Kaggle U-net</a>
keras 提供的<a href="https://keras-cn.readthedocs.io/en/latest/layers/convolutional_layer/">conv3d</a>：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keras.layers.convolutional.Conv3D(
    filters, # 卷积核的数目（即输出的维度）
    kernel_size, # 单个整数或由3个整数构成的list/tuple，卷积核的宽度和长度。如为单个整数，则表示在各个空间维度的相同长度。
    strides=(1, 1, 1),
    padding='valid',
    data_format=None,
    dilation_rate=(1, 1, 1),
    activation=None,
    use_bias=True,
    kernel_initializer='glorot_uniform',
    bias_initializer='zeros',
    kernel_regularizer=None,
    bias_regularizer=None,
    activity_regularizer=None,
    kernel_constraint=None,
    bias_constraint=None)
</code></pre></div></div>

<p>三维卷积对三维的输入进行滑动窗卷积，当使用该层作为第一层时，应提供input_shape参数。例如input_shape = (3,10,128,128)代表对10帧128*128的彩色RGB图像进行卷积。数据的通道位置仍然有data_format参数指定。</p>

<p>输入shape</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">‘channels_first’</code>模式下，输入应为形如<code class="highlighter-rouge">（samples，channels，input_dim1，input_dim2, input_dim3）</code>的5D张量</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">‘channels_last’</code>模式下，输入应为形如<code class="highlighter-rouge">（samples，input_dim1，input_dim2, input_dim3，channels）</code>的5D张量</p>
  </li>
</ul>

<p>这里的输入shape指的是函数内部实现的输入shape，而非函数接口应指定的input_shape。</p>


                <p class="post-info">
                    本文由 <a href="/">Rowl1ng</a> 创作，采用 <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">知识共享署名4.0</a> 国际许可协议进行许可<br>本站文章除注明转载/出处外，均为本站原创或翻译，转载前请务必署名<br>最后编辑时间为:2017-04-25 19:04:00
                </p>

            </div>
            <div id="container"></div>
            <link rel="stylesheet" href="/css/gitment.css">
            <script src="/js/gitment.browser.js"></script>
            <script>
                var gitment = new Gitment({
                    owner: 'Rowl1ng',
                    repo: 'rowl1ng.github.io',
                    oauth: {
                        client_id: 'd3a4fe07f0e275a814af',
                        client_secret: '568c448355abf329a831ea9e1cbcaf94dab7ce8b',
                    },
                })
                gitment.render('container')
            </script>
            <!--<div id="gitmentContainer"></div>-->
            <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
            <!--<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>-->
            <!--<script>-->
                <!--var gitment = new Gitment({-->
                    <!--owner: 'Rowl1ng',-->
                    <!--repo: 'rowl1ng.github.io',-->
                    <!--oauth: {-->
                        <!--client_id: 'd3a4fe07f0e275a814af',-->
                        <!--client_secret: '568c448355abf329a831ea9e1cbcaf94dab7ce8b',-->
                    <!--},-->
                <!--});-->
                <!--gitment.render('gitmentContainer');-->
            <!--</script>-->

        </article>
        <footer class="footer bg-white">
    <div class="footer-social">
        <div class="footer-container clearfix">
            <div class="social-list">
                <!--<a class="social segmentfault" target="blank" href="https://segmentfault.com/u/rowl1ng" title="访问 LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>-->
                <a class="social github" target="blank" href="https://github.com/rowl1ng" title="访问 Rowl1ng_Github" data-hover="GitHub">GitHub</a>
                <a class="social deviantart" target="blank" href="https://sixijinling.deviantart.com/" title="访问 Rowl1ng_deviantart" data-hover="deviantart">Deviantart</a>
                <a class="social bilibili" target="blank" href="https://space.bilibili.com/3556743/#!/index" title="访问 Rowl1ng_bilibili" data-hover="bilibili">bilibili</a>
                <!--<a class="social twitter" target="blank" href="http://twitter.com/rowl1ng" title="访问 LiberXue_Twitter" data-hover="Twitter">Twitter</a>-->
                <!--<a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/rowl1ng" title="访问 LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>-->
                <a class="social douban" target="blank" href="https://www.douban.com/people/rowl1ng/" title="访问 Rowl1ng_douban" data-hover="douban">douban</a>
                <a class="social rss" target="blank" href="/feed.xml"title="访问 Rowl1ng_RSS" data-hover="RSS">RSS</a>
            </div>
        </div>
    </div>
    <div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                        <img src="http://localhost:4000/style/images/logo-rowl1ng.png"   title="访问 Rowl1ng_blog" data-hover="Rowl1ng_blog" alt="Rowl1ng_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://rowl1ng.com/2017/08/03/Jekyllthemes.html" title="访问 Jekyll Rowl1ng主题"  data-hover="Jekyll Rowl1ng"target="_blank">Jekyll rowl1ng</a> by <a href="http://rowl1ng.com/about" target="_blank">Rowl1ng</a></p>
                        <p>Powered by <a href="http://localhost:4000/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2018 <a href="/feed.xml"  title="访问 Rowl1ng blog RSS" data-hover="Rowl1ng blog RSS">Rowl1ng blog RSS</a></p>
                        <p>总计文章：篇</p>
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">置顶文章</h3>
                <!--置顶-->
                
                
                
                
                
                
                
                
                
                
                <li><a href="/%E6%8A%80%E6%9C%AF/chatbot.html" title="访问 基于Rasa_NLU的微信chatbot" data-hover="基于Rasa_NLU的微信chatbot">基于Rasa_NLU的微信chatbot</a></li>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <!--置顶-->
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">最新文章</h3>
                
                <!---->
                
                <!---->
                
                <!---->
                    <li><a href="/%E5%AD%A6%E4%B9%A0/English.html" title="访问 各种英语考试的经验" data-hover="各种英语考试的经验">各种英语考试的经验</a></li>
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                    <li><a href="/%E8%AF%BB%E4%B9%A6/Socialism.html" title="访问 《观念的水位》+《柏林墙》" data-hover="《观念的水位》+《柏林墙》">《观念的水位》+《柏林墙》</a></li>
                <!---->
                
                <!---->
                
                <!---->
                    <li><a href="/%E8%AF%BB%E4%B9%A6/watch_TV.html" title="访问 爱好：看电视" data-hover="爱好：看电视">爱好：看电视</a></li>
                <!---->
                
                <!---->
                
            </div>
        </div>
    </div>
</footer>
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script src="/search/js/cb-search.js"></script>
<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
        <div id="directory-content" class="directory-content">
            <div id="directory"></div>
        </div>
        <script>
            var postDirectoryBuild = function() {
                var postChildren = function children(childNodes, reg) {
                    var result = [],
                        isReg = typeof reg === 'object',
                        isStr = typeof reg === 'string',
                        node, i, len;
                    for (i = 0, len = childNodes.length; i < len; i++) {
                        node = childNodes[i];
                        if ((node.nodeType === 1 || node.nodeType === 9) &&
                            (!reg ||
                                isReg && reg.test(node.tagName.toLowerCase()) ||
                                isStr && node.tagName.toLowerCase() === reg)) {
                            result.push(node);
                        }
                    }
                    return result;foot
                },
                createPostDirectory = function(article, directory, isDirNum) {
                    var contentArr = [],
                        titleId = [],
                        levelArr, root, level,
                        currentList, list, li, link, i, len;
                    levelArr = (function(article, contentArr, titleId) {
                        var titleElem = postChildren(article.childNodes, /^h\d$/),
                            levelArr = [],
                            lastNum = 1,
                            lastRevNum = 1,
                            count = 0,
                            guid = 1,
                            id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                            lastRevNum, num, elem;
                        while (titleElem.length) {
                            elem = titleElem.shift();
                            contentArr.push(elem.innerHTML);
                            num = +elem.tagName.match(/\d/)[0];
                            if (num > lastNum) {
                                levelArr.push(1);
                                lastRevNum += 1;
                            } else if (num === lastRevNum ||
                                num > lastRevNum && num <= lastNum) {
                                levelArr.push(0);
                                lastRevNum = lastRevNum;
                            } else if (num < lastRevNum) {
                                levelArr.push(num - lastRevNum);
                                lastRevNum = num;
                            }
                            count += levelArr[levelArr.length - 1];
                            lastNum = num;
                            elem.id = elem.id || (id + guid++);
                            titleId.push(elem.id);
                        }
                        if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;
                        return levelArr;
                    })(article, contentArr, titleId);
                    currentList = root = document.createElement('ul');
                    dirNum = [0];
                    for (i = 0, len = levelArr.length; i < len; i++) {
                        level = levelArr[i];
                        if (level === 1) {
                            list = document.createElement('ul');
                            if (!currentList.lastElementChild) {
                                currentList.appendChild(document.createElement('li'));
                            }
                            currentList.lastElementChild.appendChild(list);
                            currentList = list;
                            dirNum.push(0);
                        } else if (level < 0) {
                            level *= 2;
                            while (level++) {
                                if (level % 2) dirNum.pop();
                                currentList = currentList.parentNode;
                            }
                        }
                        dirNum[dirNum.length - 1]++;
                        li = document.createElement('li');
                        link = document.createElement('a');
                        link.href = '#' + titleId[i];
                        link.title = '访问' + titleId[i];
                        link.title = '访问' + titleId[i];
                        link.innerHTML = !isDirNum ? contentArr[i] :
                            dirNum.join('.') + ' ' + contentArr[i] ;
                        li.appendChild(link);
                        currentList.appendChild(li);
                    }
                    directory.appendChild(root);
                };
                createPostDirectory(document.getElementById('post-content'),document.getElementById('directory'), true);
            };
            postDirectoryBuild();
        </script>
        <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
        <script >lang=hljs.initHighlightingOnLoad();</script>
        
        <!--<script type='text/javascript' -->
                <!--href='https://use.typekit.net/cwj3gfk.js'>-->
        <!--</script>-->
        <!--<script type='text/javascript'). try{Typekit.load({ async: true });}catch(e){}>-->
        <!--</script>-->
    </body>
</html>