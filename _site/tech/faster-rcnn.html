
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">
    <head>
        <meta content='Faster R-CNN 检测微小物体 - Rowl1ng|黑客与画家' name='title' />
        <meta content='Faster R-CNN 检测微小物体 - Rowl1ng|黑客与画家' name='og:title' />
        <title>Faster R-CNN 检测微小物体 - Rowl1ng|黑客与画家</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Faster R-CNN 检测微小物体 - Rowl1ng|黑客与画家</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Faster R-CNN 检测微小物体 - Rowl1ng|黑客与画家">
<meta name="twitter:keywords"  content="本文基于Faster R-CNN的pytorch实现，原始论文，需要安装：pip install easydict数据输入：使用自己的数据设计yourdata.py参考dataset目录下的其他数据集的类进行修改：  _classes..." property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="Faster R-CNN 检测微小物体 - Rowl1ng|黑客与画家">
<meta property="og:description" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="og:keywords"  content="本文基于Faster R-CNN的pytorch实现，原始论文，需要安装：pip install easydict数据输入：使用自己的数据设计yourdata.py参考dataset目录下的其他数据集的类进行修改：  _classes..." property='og:description' />
<meta name="theme-Jekyll by Rowl1ng" content="#eb5055">
<link rel="icon" type="image/png" href="http://localhost:4000/style/favicons/favicon.ico" />
<link href="http://localhost:4000/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="http://localhost:4000/">
<link rel="alternate" type="application/rss+xml" title="Rowl1ng" href="http://localhost:4000/feed.xml">
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="http://localhost:4000/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords"  content="本文基于Faster R-CNN的pytorch实现，原始论文，需要安装：pip install easydict数据输入：使用自己的数据设计yourdata.py参考dataset目录下的其他数据集的类进行修改：  _classes..." property='og:description' />
<meta name="description" content="nothing is more practicla than a good theory" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">

<link href="http://localhost:4000/style/style-rowl1ng.css" rel="stylesheet">

    <meta content='http://localhost:4000/tech/faster-rcnn.html' property='og:url' />
    <meta content="Faster R-CNN用来识别大件物体效果好，但是小物体效果较差，因此想了一些改进的方法。" property='og:description' />
    <meta content="article" property="og:type" />


    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-71226909-1', 'auto');
        ga('send', 'pageview');
    </script>

    </head>
    <body class="" gtools_scp_screen_capture_injected="true">
        <header id="header" class="header bg-white">
            <div class="navbar-container">
                <a href="/?rowl1ng" title="访问 Rowl1ng|黑客与画家" class="navbar-logo"> <img src="http://localhost:4000/style/images/logo-rowl1ng.png" alt="Rowl1ng|黑客与画家"> </a>
                <div class="navbar-menu">
                    
                        <a href="http://localhost:4000/tech">技术</a>
                    
                        <a href="http://localhost:4000/art">艺术</a>
                    
                        <a href="http://localhost:4000/book">读书</a>
                    
                        <a href="http://localhost:4000/write">写作</a>
                    
                        <a href="http://localhost:4000/archives">归档</a>
                    
                        <a href="http://localhost:4000/tags">标签</a>
                    
                        <a href="http://localhost:4000/about">关于</a>
                    
                </div>
                <div class="navbar-search" onclick="">
                    <span class="icon-search"></span>
                    <form id="cb-search-btn" role="search">
                        <span class="search-box">
                             <input type="text" class="input" id="cb-search-content" required="true" placeholder="标题 标签..." maxlength="30" autocomplete="off">
                        </span>
                    </form>
                </div>
                <div class="navbar-mobile-menu" onclick="">
                    <span class="icon-menu cross"><span class="middle"></span></span>
                    <ul>
                        
                            <li><a href="http://localhost:4000/tech">技术</a></li>
                        
                            <li><a href="http://localhost:4000/art">艺术</a></li>
                        
                            <li><a href="http://localhost:4000/book">读书</a></li>
                        
                            <li><a href="http://localhost:4000/write">写作</a></li>
                        
                            <li><a href="http://localhost:4000/archives">归档</a></li>
                        
                            <li><a href="http://localhost:4000/tags">标签</a></li>
                        
                            <li><a href="http://localhost:4000/about">关于</a></li>
                        
                    </ul>
                </div>
            </div>
        </header>
        <div class="post-header-thumb bg-white}">
            <div class="post-header-thumb-op"></div>
            <div class="post-header-thumb">
                <div class="post-header-thumb-container">
                    <h1 class="post-title" itemprop="name headline">
                        Faster R-CNN 检测微小物体</h1>
                    <div class="post-data">
                        <time datetime="2018-03-22 18:26:00" itemprop="datePublished">发布时间：2018-03-22 18:26:00</time>
                        <a href="/tags#tech" title="访问 tech" data-hover="博客分类: tech">博客分类: tech</a>
                        <a href="#read"> 阅读次数: comments</a>
                    </div>
                    <div class="post-tags">
                        
                            
                            
                                
                                <a href="/tags#object detection" title="访问object detection" data-hover="object detection">
                                    object detection <span>(1)</span>
                                    
                                </a>
                                
                            
                            
                        
                    </div>
                </div>
            </div>
        </div>
        <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
            <div class="post-header">
                <h1 class="post-title" itemprop="name headline">
                    Faster R-CNN 检测微小物体</h1>
                <div class="post-data">
                    <time datetime="2018-03-22 18:26:00" itemprop="datePublished">2018-03-22 18:26:00</time>
                </div>
            </div>
            <div id="post-content" class="post-content" itemprop="articleBody">
                <p class="post-tags">
                    
                        
                        
                            
                                <a href="/tags#object detection" title="访问object detection" data-hover="object detection">
                                    object detection <span>(1)</span>
                                    
                                </a>
                            
                        
                        
                    
                </p>
                <p>本文基于<a href="https://github.com/jwyang/faster-rcnn.pytorch">Faster R-CNN的pytorch实现</a>，<a href="https://arxiv.org/pdf/1506.01497.pdf">原始论文</a>，需要安装：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install easydict
</code></pre></div></div>

<h2 id="数据输入使用自己的数据设计yourdatapy">数据输入：使用自己的数据设计yourdata.py</h2>

<p>参考dataset目录下的其他数据集的类进行修改：</p>

<ul>
  <li><code class="highlighter-rouge">_classes</code>：所有框的类别，比较特殊的就是<code class="highlighter-rouge">__background__</code></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Pascal_VOC
self._classes = ('__background__',  # always index 0
                 'aeroplane', 'bicycle', 'bird', 'boat',
                 'bottle', 'bus', 'car', 'cat', 'chair',
                 'cow', 'diningtable', 'dog', 'horse',
                 'motorbike', 'person', 'pottedplant',
                 'sheep', 'sofa', 'train', 'tvmonitor')
</code></pre></div></div>
<ul>
  <li>关键要修改的函数就是<code class="highlighter-rouge">_load_XXX_annotation(self, index)</code>（XXX是你的数据集的名字），要实现的功能就是给定image的index，返回所有的bounding box标注。
    <ul>
      <li>返回的东西长这样：
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  return {'width': width,
      'height': height,
      'boxes': np.array(boxes),
      'gt_classes': np.array(gt_classes),
      'gt_overlaps': overlaps,
      'flipped': False,
      'seg_areas': np.array(seg_areas)}
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">flipped</code>：默认是horizontal flip，我自己加了vertical flip。
    <ul>
      <li>源代码将image_id * 2作为翻转后的图像的index，因此还是要把数据集的index单独存数字id，通过id索引path</li>
      <li>同时修改<code class="highlighter-rouge">dataset/minibatch.py</code>来支持上下翻转</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">gt_overlaps</code>:Crowd instances are
  handled by marking their overlaps (with all categories) to -1. This overlap value means that crowd “instances” are excluded from training.</li>
  <li><code class="highlighter-rouge">seg_areas</code>:</li>
</ul>

<h3 id="图像预处理">图像预处理</h3>

<ul>
  <li>减去的均值是固定的$3 \times 1$向量；</li>
  <li>图像rescale到显存支持的一定大小。 <code class="highlighter-rouge">targetSize</code> 和 <code class="highlighter-rouge">maxSize</code> 默认是 600 和 1000 ，根据显存大小和图片大小来设计就好（比如最长边限制在2100或者短边是1700的时候一块gpu只能跑一个sample）。
    <ul>
      <li>代码里用<code class="highlighter-rouge">need_crop</code>来标识是否需要rescale</li>
    </ul>
  </li>
</ul>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa46e9e0bbd7.png" alt="此处输入图片的描述" /></p>

<p>#网络结构</p>

<p>R-CNN包括三种主要网络：</p>

<ol>
  <li>Head：输入(w,h,3)生成feature map，降采样了16倍；
    <ul>
      <li>w和h是预处理以后的图片大小哦</li>
    </ul>
  </li>
  <li>Region Proposal Network (RPN)：基于feature map，预测ROI；
    <ul>
      <li><code class="highlighter-rouge">Crop Pooling</code>：从feature map中crop相应位置</li>
    </ul>
  </li>
  <li>Classification Network：对crop出的区域进行分类。</li>
</ol>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5a9ffec911c19.png" alt="此处输入图片的描述" /></p>

<p>先来看看Head怎么得到feature map。拿VGG16作为backbone来举例的话，一个完整的VGG16网络长这样：</p>

<p><img src="https://tryolabs.com/images/blog/post-images/2018-01-18-faster-rcnn/vgg.b6e48b99.png" alt="VGG16" /></p>

<p>其中红色部分就是下采样的时刻。原始论文里使用VGG16，因为提feature map只用了最后一次max pooling前面的部分，所以留下来的四次pooling总共下采样是16倍。得到的feature map长这样：</p>

<p><img src="https://tryolabs.com/images/blog/post-images/2018-01-18-faster-rcnn/image-to-feature-map.89f5aecb.png" alt="under sampling" /></p>

<p>最终的feature映射回原图的话大概长这样：</p>

<p><img src="https://tryolabs.com/images/blog/post-images/2018-01-18-faster-rcnn/anchors-centers.141181d6.png" alt="此处输入图片的描述" /></p>

<p>有了feature map以后，开始走RCNN的主体流程：</p>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa0053323ac5.png" alt="此处输入图片的描述" /></p>

<h3 id="1-anchor-generation-layer">1. Anchor Generation Layer</h3>

<p>第一步就是生成anchor，这里的anchor亦可理解为bounding box。rpn的任务是对上上图的每个小红点都计算若干anchor（默认是9个）：</p>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa05d3ecef3e.png" alt="此处输入图片的描述" /></p>

<ul>
  <li>三种颜色分别代表128x128, 256x256, 512x512</li>
  <li>每种颜色的三个框分别代表比例1:1, 1:2 and 2:1</li>
</ul>

<blockquote>
  <p>anchor是RPN的windows的大小，在feature map的每一个位置使用不同尺度和长宽比的window提取特征。原论文描述为“a pyramid of regression references”。</p>
</blockquote>

<p>对应到代码上：在trainval_net.py中，imagenet的<code class="highlighter-rouge">ANCHOR_SCALES</code>的默认是[4, 8, 16, 32]，<code class="highlighter-rouge">ANCHOR_RATIOS</code>默认是[0.5,1,2]。但是并不是越多越好，要控制在一定的数量，理由是：</p>

<ol>
  <li>anchors多了就会造成faster RCNN的时间复杂度提高，anchors多的最极端情况就是overfeats中sliding windows。</li>
  <li>使用多尺度的anchors未必全部对scale-invariant property都有贡献</li>
</ol>

<p>所以，在使用自己的数据的时候，统计一下gorund truth框的大小（注意考虑预处理rescale的系数），确定大小范围还是很有必要的。</p>

<h3 id="2-region-proposal-layer">2. Region Proposal Layer</h3>

<p>先明确foreground和background的概念：前景<code class="highlighter-rouge">fg</code>（foreground）代表有物体（不管是哪个类别），背景<code class="highlighter-rouge">bg</code>（background）就是没有任何物体。</p>

<p>前一步生成anchor得到的是dense candidate region，rpn根据region是fg的概率来对所有region排序。</p>

<p>Region Proposal Layer的两个任务就是：</p>

<ul>
  <li><code class="highlighter-rouge">rpn_cls_score</code>:判断anchor是前景还是背景</li>
  <li><code class="highlighter-rouge">rpn_bbox_pred</code>:根据<strong>regression coefficient</strong>调整anchor的位置、长宽，从而改进anchor，比如让它们更贴合物体边界。</li>
</ul>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa0695484e3e.png" alt="此处输入图片的描述" /></p>

<p>值得注意的是，这里的anchor是以降采样16倍得到的feature map为基础的，所以总共是$\frac w {16} * \frac h {16} * 9$个anchor。每个anchor唯一对应着一个class score和bounding box regressor。</p>

<h4 id="proposal-layer">Proposal Layer</h4>

<p>基于fg的score，使用nms来筛除多余的anchor</p>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa5766d53b63.png" alt="此处输入图片的描述" /></p>

<h4 id="anchor-target-layer">Anchor Target Layer</h4>

<p>计算RPN loss：</p>

<p><img src="http://www.telesens.co/wordpress/wp-content/ql-cache/quicklatex.com-142d5b70256748a64605bfc6e2f30ea9_l3.svg" alt="此处输入图片的描述" /></p>

<ul>
  <li>Classification Loss: cross_entropy(predicted _class, actual_class)</li>
  <li>Bounding Box Regression Loss:<img src="http://www.telesens.co/wordpress/wp-content/ql-cache/quicklatex.com-79e8cbe4b5682f6abc719c54d768a4ae_l3.svg" alt="此处输入图片的描述" />
<img src="http://www.telesens.co/wordpress/wp-content/ql-cache/quicklatex.com-f26b9d082be79d08e06cdbeb5cfc1e3a_l3.svg" alt="此处输入图片的描述" />
<img src="http://www.telesens.co/wordpress/wp-content/ql-cache/quicklatex.com-dae64c7ea8affa572e4b38b84688e1fd_l3.svg" alt="此处输入图片的描述" /></li>
</ul>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa13d4d911d3.png" alt="此处输入图片的描述" /></p>

<p>需要注意的是，fg/bg并不是“非黑即白”，而是有“don’t care”这单独的一类，用来标识既不是fg也不是bg的box，这些框也就不在loss的计算范围中。同时，“don’t care”也用来约束fg和bg的总数和比例，比如多余的fg随机标为“don’t care”。</p>

<p>一些相关参数：</p>

<ul>
  <li><code class="highlighter-rouge">TRAIN.RPN_POSITIVE_OVERLAP</code>: 用来筛选fg box的阈值(Default: 0.7)</li>
  <li><code class="highlighter-rouge">TRAIN.RPN_NEGATIVE_OVERLAP</code>: 用来筛选bg box的阈值(Default: 0.3)。这样一来，和ground truth的overlap在0.3~0.7就是“don’t care”。</li>
  <li><code class="highlighter-rouge">TRAIN.RPN_BATCHSIZE</code>: fg和bg anchor的总数 (default: 256)</li>
  <li><code class="highlighter-rouge">TRAIN.RPN_FG_FRACTION</code>: batch size中fg的比例 (default: 0.5)。如果fg数量超过 TRAIN.RPN_BATCHSIZE$\times$ TRAIN.RPN_FG_FRACTION, 超过的部分 (根据索引随机选择) 就被标为 “don’t care”.</li>
</ul>

<p>输入:</p>

<ul>
  <li>RPN Network Outputs (predicted foreground/background class labels, regression coefficients)</li>
  <li>Anchor boxes (generated by the anchor generation layer)</li>
  <li>Ground truth boxes</li>
</ul>

<p>输出：</p>

<ul>
  <li>Good foreground/background boxes and associated class labels</li>
  <li>Target regression coefficients</li>
</ul>

<h4 id="proposal-target-layer">Proposal Target Layer</h4>

<p>proposal layer产生ROI list，而Proposal Target Layer负责从这个list中选出可信的ROI。这些ROI经过 crop pooling从feature map中crop出相应区域，传给后面的classification
layer（head_to_tail）.</p>

<p>计算所有ROI和所有ground truth的max overlap，从而判断是fg还是bg。这里用到了两个参数：</p>

<ul>
  <li><code class="highlighter-rouge">TRAIN.FG_THRESH</code>：用来判断fg ROI（default：0.5）</li>
  <li><code class="highlighter-rouge">TRAIN.BG_THRESH_LO</code> ~ <code class="highlighter-rouge">TRAIN.BG_THRESH_HI</code>：这个区间的是bg ROI。(default 0.1, 0.5 respectively)</li>
</ul>

<p>这样的设计可以看作是 “hard negative mining” ，用来给classifier投喂更难的bg样本。</p>

<blockquote>
  <p>为了保证fg和bg的总数是恒定的（N），如果bg太少了，就会随机重复一些bg样本来弥补差额。</p>
</blockquote>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa32302afc0b.png" alt="此处输入图片的描述" /></p>

<p>神奇的一点：在后面的classification layer中，这个bbox_inside_weights起一个mask的作用，这样就只计算fg的，不管bg的，但是算分类loss的时候还是都考虑。</p>

<p>输入:</p>

<ul>
  <li>ROIs produced by the proposal layer</li>
  <li>ground truth information</li>
</ul>

<p>输出:</p>

<ul>
  <li>Selected foreground and background ROIs that meet overlap criteria.</li>
  <li>Class specific target regression coefficients for the ROIs</li>
</ul>

<p>Parameters:</p>

<ul>
  <li><code class="highlighter-rouge">TRAIN.BATCH_SIZE</code>: (default 128) 所选fg和bg box的最大数量.</li>
  <li><code class="highlighter-rouge">TRAIN.FG_FRACTION</code>: (default 0.25). fg box 不能超过 BATCH_SIZE*FG_FRACTION</li>
</ul>

<h3 id="roi-pooling-layer">ROI Pooling Layer</h3>

<p>简言之就是负责从feature map中提取ROI对应区域。</p>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa402baba3a1.png" alt="此处输入图片的描述" /></p>

<p>Pytorch的<strong>torch.nn.functional.affine_grid</strong> 和torch.nn.functional.grid_sample</p>

<p>crop pooling的步骤：</p>

<ol>
  <li>ROI坐标 $\div$ head网络下采样的倍数（也就是stride）。需要特别指出的是：proposal target layer给出的ROI坐标是原图尺度上的（默认800$\times$600），因此映射到feature map之前要先除stride（默认是16，前面解释过）。</li>
  <li>affine transformation matrix（仿射变换矩阵）</li>
  <li>最关键的一点在于后面的分类网接收的是固定大小输入，因此这一步需要把矩形窗</li>
</ol>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa4255fdacb6.png" alt="此处输入图片的描述" /></p>

<h3 id="classification-layer">Classification Layer</h3>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa55c81eac0a.png" alt="此处输入图片的描述" /></p>

<p>fc之后得到的一维特征向量被送到两个全连接网络中：
<img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa55c97f3287.png" alt="此处输入图片的描述" /></p>

<ul>
  <li><code class="highlighter-rouge">cls_score_net</code>：生成roi每个类别的score（softmax之后就是概率了）</li>
  <li><code class="highlighter-rouge">bbox_pred_net</code>：结合两者得到最终的bbox坐标
    <ul>
      <li>class specific bounding box regression coefficients</li>
      <li>原来proposal target layer生成的 bbox 坐标</li>
    </ul>
  </li>
</ul>

<p>这个阶段要把不同物体的标签考虑进来了，所以是一个多分类问题。使用交叉熵计算分类Loss：</p>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa1cd250f265.png" alt="此处输入图片的描述" /></p>

<p>这个阶段依然要计算bounding box regression loss，和前面的R区别PN的区别在于：</p>

<ul>
  <li>RPN的是为了让bbox更紧凑地贴合物体。 anchor target layer算得的target regression coefficients需要将roi box和离它最近的ground truth bbox对齐。</li>
  <li>classification layer中的是针对各个类别的。也就是说，对每个roi、每个类别都会生成一套coefficient。只有那些分类正确了的box才能参与，分类错误的直接不考虑了。</li>
</ul>

<blockquote>
  <p>代码实现上：使用了mask array将for循环操作转化成了矩阵乘法。mask array标注了每个anchor的正确物体类别。</p>
</blockquote>

<p>有意思的是，训练classification layer得到的loss也会反向传播给RPN。这是因为用来做crop pooling的ROI box坐标不仅是RPN产生的 regression coefficients应用到anchor box上的结果，其本身也是网络输出。因此，在反传的时候，误差会通过roi pooling layer传播到RPN layer。好在crop pooling在Pytorch中有内部实现，省去了计算梯度的麻烦。</p>

<h2 id="inference">Inference</h2>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa70ff399c57.png" alt="此处输入图片的描述" /></p>

<h2 id="针对小物体">针对小物体</h2>

<p>每个小红点之间就是16像素的间隔了，如果要检测特别细小的物体，这么大的下采样就很危险了。于是，为了尽量不破坏细小物体的清晰度，参考<a href="https://github.com/rbgirshick/py-faster-rcnn/issues/86">github上关于检测微小物体的讨论</a>，我尝试了两种方案：</p>

<h3 id="1-降低下采样">1. 降低下采样</h3>

<ul>
  <li>一旦改变下采样，同时还要改变feature_stride和spatial_scale。否则预测框框就变成了边缘的线条（同时loss_rpn_cls奇高）。比如VGG16（降采样8倍）：
    <ul>
      <li>__C.feat_stride’: 8”</li>
      <li>self.spatial_scale to (1/8)</li>
    </ul>
  </li>
  <li>vgg16尝试4倍下采样：去掉了stage5的卷积，保障输入图像最短边在1200</li>
</ul>

<h4 id="剪裁网络">剪裁网络</h4>

<p><a href="https://stackoverflow.com/questions/44146655/how-to-convert-pretrained-fc-layers-to-conv-layers-in-pytorch">把卷积层变成全连接层</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>list(model.modules()) # to inspect the modules of your model
my_model = nn.Sequential(*list(model.modules())[:-1]) # strips off last linear layer
</code></pre></div></div>

<h3 id="2-切割原图">2. 切割原图</h3>

<ul>
  <li>训练数据切patch：将原图切分为四等份再训练，保障大部分图的清晰度不被压缩。这样一来，标注也要做调整：
    <ul>
      <li>一种方式是重新生成新的子图标注，新写一个yourdata.py；</li>
      <li>另一种偷懒方式则是修改 yourdata.py的<code class="highlighter-rouge">_load_XXX_anotation(self, index)</code>，使得读入每个子图，返回的也是每个子图的所有标注框。</li>
    </ul>
  </li>
  <li>测试数据为原图，沿用原来的数据读入方式即可。</li>
</ul>

<h1 id="appendix">Appendix</h1>

<h2 id="non-maximum-suppressionnms">non-maximum suppression（nms）</h2>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa7c84451f81.png" alt="此处输入图片的描述" /></p>

<p>上图左边的黑色数字代表fg的概率</p>

<ul>
  <li>standard NMS (boxes are ranked by y coordinate of bottom right corner). This results in the box with a lower score being retained. The second figure uses modified NMS (boxes are ranked by foreground scores).</li>
</ul>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa7c828703ab.png" alt="此处输入图片的描述" /></p>

<ul>
  <li>This results in the box with the highest foreground score being retained, which is more desirable. In both cases, the overlap between the boxes is assumed to be higher than the NMS overlap threhold.</li>
</ul>

<p><a href="https://zhuanlan.zhihu.com/p/31427728">讲nms（non-maximum suppression）的文章</a></p>

<h2 id="resnet50">Resnet50</h2>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa59c8da4c4b.png" alt="此处输入图片的描述" /></p>

<p><img src="http://www.telesens.co/wordpress/wp-content/uploads/2018/03/img_5aa59d170c750.png" alt="此处输入图片的描述" /></p>
<ul>
  <li>resnet的downsample：第一个卷积层就降采样了2倍</li>
  <li>Resnet18，降低下采样，增加卷积层
<img src="http://static.zybuluo.com/sixijinling/9khganmk3o5gosnvde9l78o2/image_1c8u6de3r12s5oeog9i1ij6d1g9.png" alt="image_1c8u6de3r12s5oeog9i1ij6d1g9.png-183.1kB" />
检查网络输出</li>
</ul>

<h2 id="fpn">FPN</h2>
<p><img src="http://static.zybuluo.com/sixijinling/cv2l758k7dyj022k0iinwsm1/image_1c8u6egich3e1ha41d3o1m22s3g16.png" alt="image_1c8u6egich3e1ha41d3o1m22s3g16.png-228.8kB" />
<img src="http://static.zybuluo.com/sixijinling/elabj076z56xa1xsfbwqyy50/image_1c8u6f7esu9i1sl510hs1pnm1qvl1j.png" alt="image_1c8u6f7esu9i1sl510hs1pnm1qvl1j.png-30.8kB" />
<a href="https://arxiv.org/pdf/1612.03144.pdf">原始论文</a>
<a href="https://github.com/jwyang/fpn.pytorch">FPN的Pytorch实现</a></p>

<h3 id="focal-loss">Focal loss</h3>

<p>看ICCV那篇focal loss的论文</p>

<p><a href="https://github.com/marvis/pytorch-yolo2/blob/master/FocalLoss.py">Pytorch实现参考</a></p>

<h2 id="todo-list">Todo List</h2>

<ul>
  <li>[ ] face book开源的基于caffe2的detectron，也可以学习一下，里面有各种检测的算法，有mask rcnn神马的</li>
  <li><a href="http://forums.fast.ai/t/implementing-mask-r-cnn/2234">关于mask rcnn实现的讨论</a>，kaggle上也有一个做医疗图像的demo</li>
  <li>[ ] 可能是resnet的bn_train设置为False，回头改一下</li>
  <li>加入valid过程，确认是否有过拟合:爆显存了</li>
  <li>[ ] roibatchloader的问题：trim</li>
  <li>遇到的bug
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>random.choice()
</code></pre></div>    </div>
  </li>
  <li>negative sampling：selective search</li>
</ul>

<h2 id="reference">Reference</h2>

<ul>
  <li>如果想了解object detection的发展史，可以看<a href="https://tryolabs.com/blog/2017/08/30/object-detection-an-overview-in-the-age-of-deep-learning/">Object Detection</a></li>
  <li>
    <p>推荐阅读<a href="https://tryolabs.com/blog/2018/01/18/faster-r-cnn-down-the-rabbit-hole-of-modern-object-detection/">Faster R-CNN: Down the rabbit hole of modern object detection</a></p>

  </li>
</ul>

                <p class="post-info">
                    本文由 <a href="/">Rowl1ng</a> 创作，采用 <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">知识共享署名4.0</a> 国际许可协议进行许可<br>本站文章除注明转载/出处外，均为本站原创或翻译，转载前请务必署名<br>最后编辑时间为:2018-03-22 18:26:00
                </p>

            </div>
            <div id="container"></div>
            <link rel="stylesheet" href="/css/gitment.css">
            <script src="/js/gitment.browser.js"></script>
            <script>
                var gitment = new Gitment({
                    owner: 'Rowl1ng',
                    repo: 'rowl1ng.github.io',
                    oauth: {
                        client_id: 'd3a4fe07f0e275a814af',
                        client_secret: '568c448355abf329a831ea9e1cbcaf94dab7ce8b',
                    },
                })
                gitment.render('container')
            </script>
            <!--<div id="gitmentContainer"></div>-->
            <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
            <!--<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>-->
            <!--<script>-->
                <!--var gitment = new Gitment({-->
                    <!--owner: 'Rowl1ng',-->
                    <!--repo: 'rowl1ng.github.io',-->
                    <!--oauth: {-->
                        <!--client_id: 'd3a4fe07f0e275a814af',-->
                        <!--client_secret: '568c448355abf329a831ea9e1cbcaf94dab7ce8b',-->
                    <!--},-->
                <!--});-->
                <!--gitment.render('gitmentContainer');-->
            <!--</script>-->

        </article>
        <footer class="footer bg-white">
    <div class="footer-social">
        <div class="footer-container clearfix">
            <div class="social-list">
                <!--<a class="social segmentfault" target="blank" href="https://segmentfault.com/u/rowl1ng" title="访问 LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>-->
                <a class="social github" target="blank" href="https://github.com/rowl1ng" title="访问 Rowl1ng_Github" data-hover="GitHub">GitHub</a>
                <a class="social deviantart" target="blank" href="https://sixijinling.deviantart.com/" title="访问 Rowl1ng_deviantart" data-hover="deviantart">Deviantart</a>
                <a class="social bilibili" target="blank" href="https://space.bilibili.com/3556743/#!/index" title="访问 Rowl1ng_bilibili" data-hover="bilibili">bilibili</a>
                <!--<a class="social twitter" target="blank" href="http://twitter.com/rowl1ng" title="访问 LiberXue_Twitter" data-hover="Twitter">Twitter</a>-->
                <!--<a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/rowl1ng" title="访问 LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>-->
                <a class="social douban" target="blank" href="https://www.douban.com/people/rowl1ng/" title="访问 Rowl1ng_douban" data-hover="douban">douban</a>
                <a class="social rss" target="blank" href="/feed.xml"title="访问 Rowl1ng_RSS" data-hover="RSS">RSS</a>
            </div>
        </div>
    </div>
    <div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                        <img src="http://localhost:4000/style/images/logo-rowl1ng.png"   title="访问 Rowl1ng_blog" data-hover="Rowl1ng_blog" alt="Rowl1ng_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://rowl1ng.com/2017/08/03/Jekyllthemes.html" title="访问 Jekyll Rowl1ng主题"  data-hover="Jekyll Rowl1ng"target="_blank">Jekyll rowl1ng</a> by <a href="http://rowl1ng.com/about" target="_blank">Rowl1ng</a></p>
                        <p>Powered by <a href="http://localhost:4000/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2018 <a href="/feed.xml"  title="访问 Rowl1ng blog RSS" data-hover="Rowl1ng blog RSS">Rowl1ng blog RSS</a></p>
                        <p>总计文章：篇</p>
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">置顶文章</h3>
                <!--置顶-->
                
                
                
                
                
                
                
                
                
                
                <li><a href="/tech/chatbot.html" title="访问 基于Rasa_NLU的微信chatbot" data-hover="基于Rasa_NLU的微信chatbot">基于Rasa_NLU的微信chatbot</a></li>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <!--置顶-->
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">最新文章</h3>
                
                <!---->
                
                <!---->
                
                <!---->
                    <li><a href="/book/English.html" title="访问 各种英语考试的经验" data-hover="各种英语考试的经验">各种英语考试的经验</a></li>
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                    <li><a href="/book/Socialism.html" title="访问 《观念的水位》+《柏林墙》" data-hover="《观念的水位》+《柏林墙》">《观念的水位》+《柏林墙》</a></li>
                <!---->
                
                <!---->
                
                <!---->
                    <li><a href="/book/watch_TV.html" title="访问 爱好：看电视" data-hover="爱好：看电视">爱好：看电视</a></li>
                <!---->
                
                <!---->
                
            </div>
        </div>
    </div>
</footer>
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script src="/search/js/cb-search.js"></script>
<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
        <div id="directory-content" class="directory-content">
            <div id="directory"></div>
        </div>
        <script>
            var postDirectoryBuild = function() {
                var postChildren = function children(childNodes, reg) {
                    var result = [],
                        isReg = typeof reg === 'object',
                        isStr = typeof reg === 'string',
                        node, i, len;
                    for (i = 0, len = childNodes.length; i < len; i++) {
                        node = childNodes[i];
                        if ((node.nodeType === 1 || node.nodeType === 9) &&
                            (!reg ||
                                isReg && reg.test(node.tagName.toLowerCase()) ||
                                isStr && node.tagName.toLowerCase() === reg)) {
                            result.push(node);
                        }
                    }
                    return result;foot
                },
                createPostDirectory = function(article, directory, isDirNum) {
                    var contentArr = [],
                        titleId = [],
                        levelArr, root, level,
                        currentList, list, li, link, i, len;
                    levelArr = (function(article, contentArr, titleId) {
                        var titleElem = postChildren(article.childNodes, /^h\d$/),
                            levelArr = [],
                            lastNum = 1,
                            lastRevNum = 1,
                            count = 0,
                            guid = 1,
                            id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                            lastRevNum, num, elem;
                        while (titleElem.length) {
                            elem = titleElem.shift();
                            contentArr.push(elem.innerHTML);
                            num = +elem.tagName.match(/\d/)[0];
                            if (num > lastNum) {
                                levelArr.push(1);
                                lastRevNum += 1;
                            } else if (num === lastRevNum ||
                                num > lastRevNum && num <= lastNum) {
                                levelArr.push(0);
                                lastRevNum = lastRevNum;
                            } else if (num < lastRevNum) {
                                levelArr.push(num - lastRevNum);
                                lastRevNum = num;
                            }
                            count += levelArr[levelArr.length - 1];
                            lastNum = num;
                            elem.id = elem.id || (id + guid++);
                            titleId.push(elem.id);
                        }
                        if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;
                        return levelArr;
                    })(article, contentArr, titleId);
                    currentList = root = document.createElement('ul');
                    dirNum = [0];
                    for (i = 0, len = levelArr.length; i < len; i++) {
                        level = levelArr[i];
                        if (level === 1) {
                            list = document.createElement('ul');
                            if (!currentList.lastElementChild) {
                                currentList.appendChild(document.createElement('li'));
                            }
                            currentList.lastElementChild.appendChild(list);
                            currentList = list;
                            dirNum.push(0);
                        } else if (level < 0) {
                            level *= 2;
                            while (level++) {
                                if (level % 2) dirNum.pop();
                                currentList = currentList.parentNode;
                            }
                        }
                        dirNum[dirNum.length - 1]++;
                        li = document.createElement('li');
                        link = document.createElement('a');
                        link.href = '#' + titleId[i];
                        link.title = '访问' + titleId[i];
                        link.title = '访问' + titleId[i];
                        link.innerHTML = !isDirNum ? contentArr[i] :
                            dirNum.join('.') + ' ' + contentArr[i] ;
                        li.appendChild(link);
                        currentList.appendChild(li);
                    }
                    directory.appendChild(root);
                };
                createPostDirectory(document.getElementById('post-content'),document.getElementById('directory'), true);
            };
            postDirectoryBuild();
        </script>
        <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
        <script >lang=hljs.initHighlightingOnLoad();</script>
        
        <!--<script type="text/javascript" async-->
                <!--src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">-->
        <!--</script>-->
        <script type="text/javascript" async
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>
        
        <!--<script type='text/javascript' -->
                <!--href='https://use.typekit.net/cwj3gfk.js'>-->
        <!--</script>-->
        <!--<script type='text/javascript'). try{Typekit.load({ async: true });}catch(e){}>-->
        <!--</script>-->
    </body>
</html>