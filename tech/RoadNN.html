
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">
    <head>
        <meta content='裂缝识别 - Rowl1ng|黑客与画家' name='title' />
        <meta content='裂缝识别 - Rowl1ng|黑客与画家' name='og:title' />
        <title>裂缝识别</title>
        <!--<title>裂缝识别 - Rowl1ng|黑客与画家</title>-->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>裂缝识别 - Rowl1ng|黑客与画家</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="裂缝识别 - Rowl1ng|黑客与画家">
<meta name="twitter:keywords"  content="公路在使用过程中，总会因为行车、自然因素出现裂缝，这些裂缝如果不及时维护（填沥青）的话，可能会影响到车辆的正常通行。可是真是环境总是变化多样的，光照、磨损会带来各种干扰或是消弭调裂缝本身的可见性。于是乎，机器识别达不到的正确率只能靠人..." property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="裂缝识别">
<!--<meta property="og:title" content="裂缝识别 - Rowl1ng|黑客与画家">-->
<meta property="og:description" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="og:keywords"  content="公路在使用过程中，总会因为行车、自然因素出现裂缝，这些裂缝如果不及时维护（填沥青）的话，可能会影响到车辆的正常通行。可是真是环境总是变化多样的，光照、磨损会带来各种干扰或是消弭调裂缝本身的可见性。于是乎，机器识别达不到的正确率只能靠人..." property='og:description' />
<meta name="theme-Jekyll by Rowl1ng" content="#eb5055">
<link rel="icon" type="image/png" href="/blog/style/favicons/favicon.ico" />
<link href="/blog/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="/blog/">
<link rel="alternate" type="application/rss+xml" title="Rowl1ng" href="/blog/feed.xml">
<meta charset="UTF-8">
<!--<link rel="manifest" href="/manifest.json">-->
<link rel="shortcut icon" href="/blog/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords"  content="公路在使用过程中，总会因为行车、自然因素出现裂缝，这些裂缝如果不及时维护（填沥青）的话，可能会影响到车辆的正常通行。可是真是环境总是变化多样的，光照、磨损会带来各种干扰或是消弭调裂缝本身的可见性。于是乎，机器识别达不到的正确率只能靠人..." property='og:description' />
<meta name="description" content="nothing is more practicla than a good theory" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">

<link href="/blog/style/style-rowl1ng.css" rel="stylesheet">
<link href="/blog/style/tocbot.css" rel="stylesheet">


    <meta content='/blog/tech/RoadNN.html' property='og:url' />
    <meta content="人工识别像划重点一样，真的很枯燥很累啊" property='og:description' />
    <meta content="article" property="og:type" />


    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-71226909-1', 'auto');
        ga('send', 'pageview');
    </script>


<header id="header" class="header bg-white">
    <div class="navbar-container">
        <a href="/blog" title="访问 Rowl1ng|黑客与画家" class="navbar-logo"> <img src="/blog/style/images/logo-rowl1ng.png" alt="Rowl1ng|黑客与画家"> </a>
        <div class="navbar-menu">
            
            <a href="/blog/tech">TECH</a>
            
            <a href="/blog/art">ART</a>
            
            <a href="/blog/book">BOOK</a>
            
            <a href="/blog/write">WRITE</a>
            
            <a href="/blog/archives">ARCHIVE</a>
            
            <a href="/blog/tags">TAGS</a>
            
            <a href="/blog/about">ABOUT</a>
            
        </div>
        <div class="navbar-search" onclick="">
            <span class="icon-search"></span>
            <form id="cb-search-btn" role="search">
                        <span class="search-box">
                             <input type="text" class="input" id="cb-search-content" required="true" placeholder="title label..." maxlength="30" autocomplete="off">
                        </span>
            </form>
        </div>
        <div class="navbar-mobile-menu" onclick="">
            <span class="icon-menu cross"><span class="middle"></span></span>
            <ul>
                
                <li><a href="/blog/tech">TECH</a></li>
                
                <li><a href="/blog/art">ART</a></li>
                
                <li><a href="/blog/book">BOOK</a></li>
                
                <li><a href="/blog/write">WRITE</a></li>
                
                <li><a href="/blog/archives">ARCHIVE</a></li>
                
                <li><a href="/blog/tags">TAGS</a></li>
                
                <li><a href="/blog/about">ABOUT</a></li>
                
            </ul>
        </div>
    </div>
</header>

    </head>
    <body class="" gtools_scp_screen_capture_injected="true">
        <div class="post-header-thumb bg-white}">
            <div class="post-header-thumb-op"></div>
            <div class="post-header-thumb">
                <div class="post-header-thumb-container">
                    <h1 class="post-title" itemprop="name headline">
                        裂缝识别</h1>
                    <div class="post-data">
                        <time datetime="2015-10-18 11:12:00" itemprop="datePublished">发布时间：2015-10-18 11:12:00</time>
                        <time datetime="2015-10-18 11:12:00" itemprop="datePublished">更新时间：2015-10-18 11:12:00</time>
                        <a href="/blog/tags#tech" title="访问 tech" data-hover="博客分类: tech">博客分类: tech</a>
                        <!--busuanzi-->
                        <script async src="/blog/js/busuanzi.pure.mini.js">
                        </script>
                        <span id="busuanzi_container_page_pv">
                          阅读次数: <span id="busuanzi_value_page_pv"></span>
                        </span>
                        <!--<a href="#read"> 阅读次数: comments</a>-->
                    </div>
                    <div class="post-tags">
                        
                            
                            
                                
                                <a href="/blog/tags#CNN" title="访问CNN" data-hover="CNN">
                                    CNN <span>(1)</span>
                                    
                                </a>
                                
                                <a href="/blog/tags#图像分割" title="访问图像分割" data-hover="图像分割">
                                    图像分割 <span>(1)</span>
                                    
                                </a>
                                
                            
                            
                        
                    </div>
                </div>
            </div>
        </div>
        <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
            <div class="post-header">
                <h1 class="post-title" itemprop="name headline">
                    裂缝识别</h1>
                <div class="post-data">
                    <time datetime="2015-10-18 11:12:00" itemprop="datePublished">2015-10-18 11:12:00</time>
                </div>
            </div>
            <div id="post-content" class="post-content" itemprop="articleBody">
                <p class="post-tags">
                    
                        
                        
                            
                                <a href="/blog/tags#CNN" title="访问CNN" data-hover="CNN">
                                    CNN <span>(1)</span>
                                    
                                </a>
                            
                                <a href="/blog/tags#图像分割" title="访问图像分割" data-hover="图像分割">
                                    图像分割 <span>(1)</span>
                                    
                                </a>
                            
                        
                        
                    
                </p>
                <p>公路在使用过程中，总会因为行车、自然因素出现裂缝，这些裂缝如果不及时维护（填沥青）的话，可能会影响到车辆的正常通行。</p>

<p>可是真是环境总是变化多样的，光照、磨损会带来各种干扰或是消弭调裂缝本身的可见性。于是乎，机器识别达不到的正确率只能靠人力来弥补了。</p>

<p>但是这种单调、工作量大的活儿还是交给机器来做成本更低嘛。</p>

<p>所以我们就要用机器学习的思路来做啦～传统的就是基于特征，不管之后学习算法用的是SVM还是BP，第一步总归是人的脑力风暴来决定提取那些特征以及怎样提取。</p>

<p>可是现在有了深度学习就不一样了，输入的图片还是原原本本的样子，顶多是做一下压缩。</p>

<p>我们现在实现的模型也就是基于多层的卷积操作和pooling操作（有的地方译作池化）来逐渐“降维”，最终原来image大小的图就被一群方格代表了（我们的输出粒度是方格大小）。</p>

<p>而我现在又有想要把attention融进来的念头，毕竟卷积在做判断（softmax）的时候还是局部性的考虑，对有裂缝或是没裂缝如果说最后是有这个filter的话，应该说还是固定的，而如果能结合周围的方格状况综合考虑的话，就不算太死板。</p>

<h2 id="introduction">Introduction</h2>

<p>首先将原始图片划分为同等大小的方形区域，对这些block进行识别，可看做是粗粒度的pixel-wise图像标记，目前的标记只有两种：有裂缝、无裂缝。</p>

<p>在前期试验中，我们仅使用CNN可以很好地提取图片特征进行分类，但是：</p>

<ul>
  <li>会出现孤立“噪点”————与裂缝特征相近的单个小块被错误识别为裂缝。由于工程应用中对裂缝的定义是连续线条，这些噪点会对最后的结果带来误差。</li>
  <li>此外，有些裂纹会在中间一段不明显，CNN方法不会将这部分识别为裂缝，而工程应用恰恰需要把它们连成一体。</li>
  <li>通过单一的卷积神经网络的方法对病害中的裂缝和条形修补进行识别，在路况良好（无光照阴影，路面清洁，老化不严重）的路上识别的准确率可以达到90%以上，但是对路况普通（存在光照等问题，也存在较好路况）的路面，效果一般，准确率只能达到70%左右。</li>
</ul>

<p>因此，我们通过在CNN后增加probability inference模块改进算法：</p>

<p><strong>Conditional Random Fields(CRF)</strong>用于pixel-wise的图像标记（其实就是图像分割）。把像素的label作为形成马尔科夫场随机变量且能够获得全局观测时，CRF便可以对这些label进行建模。这种全局观测通常就是输入图像。即在判断某一个方格时需要考虑整张图的情况，从而解决“噪点”和连接的问题。</p>

<p>输入图像：
\(x=\{x_1,\dots,x_P\}\)
$P$为像素数。</p>

<p>目标输出：
\(y=\{y_1,\dots,y_B\},y_i \in L=\{l_1,l_2,\dots,l_L\}\)
因为我们判断的是每一方格<strong>是不是</strong>裂缝。因此这里的标签$L$目前只有两种。\(y_i\)即为第\(i\)个方格的标签。</p>

<p>主要参考论文：<strong>《Conditional Random Fields as Recurrent Neural Networks》</strong></p>

<p>Github : <a href="https://github.com/torrvision/crfasrnn">CRF-RNN for Semantic Image Segmentation</a></p>

<p><img src="https://github.com/torrvision/crfasrnn/raw/master/sample.png" alt="Semantic Image Segmentation" /></p>

<ul>
  <li>Contribution：这篇论文最重要的工作就是<strong>end-to-end</strong>训练。CNN负责产生unary potential，intuitively上更合理，实验效果也证明有提高。具体通过两方面来实现：
    <ul>
      <li>mean-field CRF 的RNN实现：将mean-field算法的步骤分解为CNN，这样通过迭代就成了RNN。</li>
      <li>error differential 的反向传递，CRF的error derivative直接传到了CNN。</li>
    </ul>
  </li>
  <li>关键问题：将 label assignment problem 转化为 probability inference problem ，融入对相似像素的<strong>标签一致性</strong>的推断。</li>
  <li>目标：从 coarse 到 fine-grained segmentation ，弥补 CNN 在 pixel-level labeling task 上的不足。</li>
</ul>

<h2 id="1-理论部分">1. 理论部分</h2>

<h3 id="feature-extraction--cnn"><a href="https://rowl1ng.gitbooks.io/machine-learning/content/cnn.html">Feature Extraction : CNN</a></h3>

<p><img src="http://static.zybuluo.com/sixijinling/oo489jzvkk9odwbk4vz9djr1/convolution.png" alt="此处输入图片的描述" /></p>

<p>##</p>

<p>我们的目标输出为总方格数$B$(blocks)的$D$维vectors矩阵，
相当于实现：\(img_h \times img_w \Longrightarrow block_h \times block_w \times D\)</p>

<ul>
  <li>卷积：Conv2D 维数不变</li>
  <li>池化：Maxpooling2D  缩小维数
    <ul>
      <li><code class="language-plaintext highlighter-rouge">pool_size</code></li>
      <li><code class="language-plaintext highlighter-rouge">stride</code></li>
    </ul>
  </li>
</ul>

<p>执行5次<code class="language-plaintext highlighter-rouge">pool_size</code>=2<em>2的池化就相当于\(\frac {输入图片大小}{2^5}\),这样原来的640</em>928就一步步变成了20*29。
相当于32 bits prediction
在对原始图像进行“缩放”的同时，我们实际上通过卷积操作提取每一方格内图像的标注向量<strong>annotation  vector</strong>：</p>

<ul>
  <li>\(B\)个 annotation vector，对应\(B\)个方格</li>
  <li>每个vector都是\(D\)维(dimension)的</li>
</ul>

\[a=\{\mathbf a_1,\dots,\mathbf a_B\},\mathbf a_i \in \mathbb R^D\]

<p>without considering the <strong>smoothness and consistency</strong> of the label assignment.
因此需要考虑pairwise data-dependant smoothing term.
作为CRF的一元势能量。</p>

<p>这一阶段要考虑的参数：</p>

<ul>
  <li>receptive field</li>
  <li>subsampling rate</li>
</ul>

<h3 id="关于rnn"><a href="https://rowl1ng.gitbooks.io/machine-learning/content/rnn.html">关于RNN</a></h3>

<p><img src="http://colah.github.io/posts/2015-08-Understanding-LSTMs/img/RNN-unrolled.png" alt="此处输入图片的描述" /></p>

<h3 id="关于crf概率图模型">关于CRF(概率图模型)</h3>

<p>下面来讲 CRF 用于 pixel-wise 的图像标记（其实就是图像分割）。当把像素的label作为形成马尔科夫场的随机变量，且能够获得全局观测时，CRF便可以对这些label进行建模。</p>

<p><img src="http://img.blog.csdn.net/20160423111733218" alt="CRF" /></p>
<blockquote>
  <p>图中的\(y_i\)为观测，即像素。</p>
</blockquote>

<p>定义随机变量\(X_i\)是像素\(i\)的标签。</p>

\[X_i \in L={l_1,l_2,...,l_L}\]

<ul>
  <li>\(X\)：由\(X_1,X_2,...,X_N\)组成的随机向量；</li>
  <li>\(N\)就是图像的像素个数。</li>
</ul>

<p>假设图\(G=(V,E)\)，其中\(V={X_1,X_2,\dots,X_N}\)，全局观测为（image）\(I\)。\((I,X)\)即基于Gibbs分布的CRF模型：</p>

\[P(X=x|I)=\frac 1{Z(I)}exp(-E(x|I))\]

<table>
  <tbody>
    <tr>
      <td>\(Z(I)\)是所有可能labeling的集合，保证$$P(X=x</td>
      <td>I)$$在0~1。</td>
    </tr>
  </tbody>
</table>

<p>条件随机场图像分割能量函数的构造：</p>

\[E(x)=\sum _i \varphi_u(x_i)+\sum _{i&lt;j} \varphi_p(x_i.x_j)\]

<p>这里的\(E\)可以理解为能量，也就是cost。其中\(\varphi_u(x_i)\)是将像素\(i\)标记为\(x_i\)的inverse likelihood，\(\varphi_p(x_i.x_j)\)是将\(i\)、\(j\)同时标记为\(x_i\)、\(x_j\)的能量。</p>

<h4 id="recall-the-hmm-">Recall the HMM :</h4>

<p>在做NLP的Part-of-Speech tagging（adj. n. v. prep. adv.）的时候，下层的是它的观测(word)，上层就是 word对应的词性label。</p>

\[p(l,s)=p(l_1)\prod_i p(l_i|l_{i-1})p(\omega_i|l_i)\]

<p>(<strong>transition</strong> probability x <strong>emission</strong> probability)。</p>

<p>对比一下的话，CRF可以使用更多global features，而HMM只考虑前一个label。比如POS任务里，句子结尾的一个问号增大第一个词标记为动词的概率。或许看下面这张图会领会更多：</p>

<p><img src="http://static.zybuluo.com/sixijinling/vknv3yeser2mbwwrognwjjts/1d3f9cefc0de33cfebe71bbc237ccc6b_b.png" alt="1d3f9cefc0de33cfebe71bbc237ccc6b_b.png-80.1kB" /></p>

<blockquote>
  <p>关于CRF更详细的内容可参考论文： 《 <a href="http://homepages.inf.ed.ac.uk/csutton/publications/crftut-fnt.pdf">An introduction to conditional random fields</a> 》</p>
</blockquote>

<hr />

<h2 id="2-网络构建">2. 网络构建</h2>

<ul>
  <li>结构：
    <ul>
      <li>CNN :<strong>unary</strong> potential：
\(\varphi_u(x_i)\)</li>
      <li>CRF : <strong>pairwise</strong> potential as weighted Gaussians.</li>
    </ul>
  </li>
</ul>

\[\varphi_p(x_i.x_j)=\mu (x_i,x_j)\sum_{m=1}^M \omega ^{(m)}k_G^{(m)}(\mathbf f_i,\mathbf f_j)\]

<p>其中</p>

\[k^{(m)}(\mathbf f_i,\mathbf f_j)=\exp(-\frac 12(\mathbf f_i-\mathbf f_j)^{\mathrm T}\varLambda^{(m)}(\mathbf f_i-\mathbf f_j))\]

<p>\(\mathbf f_i\)是像素\(i\)的feature vector，这里是从原图片中提取的。
<strong>Potts Model</strong> ： \(\mu(x_i,x_j)=[x_i \neq x_j]\) 是对位置接近的相似像素标记不同的惩罚项。</p>

<ul>
  <li>inference method
    <ul>
      <li><strong>back propagation</strong> : 论文中使用的是<strong>SGD</strong>来进行反向传播；</li>
      <li><strong>minibatch</strong> ：训练时可以用一整张图，也可以用多张图。</li>
    </ul>
  </li>
</ul>

<h3 id="mean-field--cnn--softmax">Mean-field = CNN + softmax</h3>

<p>基于平均场，使用更简单的分布\(Q(\mathbf X)\)来逼近CRF的\(P(\mathbf X)\)：</p>

\[U_i(l)=-\varphi_u(\mathbf X_i=l) \\
Z_i=\sum_l \exp (U_i(l))\]

<h4 id="1-首先初始化">1. 首先初始化：</h4>

<p>对每个像素上的所有label做softmax：</p>

\[Q_i(l) \leftarrow \frac 1{Z_i}\exp (U_i(l)) \\\]

<p>等同于softmax ： \(h_j = \frac{e^{z_j}}{\sum{e^{z_i}}}\)</p>

<p>由于这里不涉及其他参数，因此梯度在经过softmax的反向计算后直接传给unary potentials。</p>

\[\frac{\partial h_{j}}{\partial z_{k}} = h_{j}\delta_{kj}-h_{j}h_{k}\]

<h4 id="2-message-passing">2. Message passing:</h4>

<p>对\(Q\)进行\(M\)个高斯滤波：</p>

\[Q_j(l) \leftarrow \sum_{i \neq j} k^{(m)}(\mathbf f_i,\mathbf f_j)Q_j(l)\]

<ul>
  <li>Gaussian kernel
    <ul>
      <li>edge-preserving Gaussian filters</li>
      <li>coefficient直接从像素位置、RGB信息中来，反映和其他像素的关联程度</li>
    </ul>
  </li>
  <li>这里的CRF是potentially fully connected ，每个filter的receptive field都是整张图，强制实现不可行。
    <ul>
      <li>为了提高高位高斯铝箔的速度，使用的是Andrew Adams et al所提出的<a href="http://blog.csdn.net/xuanwu_yan/article/details/7962508"><strong>Pemutohedral Lattice</strong></a>，时间复杂度\(O(n)\)。</li>
    </ul>
  </li>
</ul>

<p>补充：
(1) 如果是<strong>稀疏条件随机场</strong>，那么我们构造图模型的边集合E就是：每对相邻的像素点间可以构造一条边。当然除了4邻域构造边之外，你也可以用8邻域模型。
(2) <strong>全连接条件随机场</strong>与稀疏条件随机场的最大差别在于：每个像素点都与所有的像素点相连接构成连接边。这就恐怖了，如果一张图像是\(100 \times 100\)，那么就相当于有10000个像素点，因此如果采用全连接条件随机场的话，那么就会构造出约\(10000 \times 10000\)条边。如果图像大小再大一些，那么就会变得非常恐怖，普通条件随机场推理算法，根本行不通。</p>

<p><img src="http://img.my.csdn.net/uploads/201211/03/1351909905_5548.png" alt="此处输入图片的描述" /></p>

<p><img src="http://img.my.csdn.net/uploads/201209/21/1348218477_3540.png" alt="此处输入图片的描述" /></p>

<ul>
  <li>分为三个步骤：
    <ul>
      <li>splat</li>
      <li>blur</li>
      <li>slice</li>
    </ul>
  </li>
  <li>
    <p>误差反向通过filter，逆转blur阶段filter的顺序，时间复杂度\(O(n)\)。</p>
  </li>
  <li>2 Guassian Kernel：<a href="http://homepages.inf.ed.ac.uk/rbf/CVonline/LOCAL_COPIES/MANDUCHI1/Bilateral_Filtering.html#The%20Gaussian%20Case">Bilateral filter</a> 和Spatial filter两种滤波器</li>
</ul>

<h4 id="3-weighting-filter-outputs">3. Weighting Filter Outputs</h4>

<p>为每个标签计算\(M\)个filter输出的weighted sum ，可以看成是有\(M\)个输入channel、1个输出channel的卷积操作。</p>

\[Q_i(l) \leftarrow \sum _m \omega ^{(m)}Q_i^{(m)}(l)\]

<p>考虑到识别对象，这里针对每个标签使用不同的spatial kernel和bilateral kernel权重，作者举的例子是bilateral filter 在识别自行车上很重要（此时颜色的相似性很关键），但识别电视机就不那么重要（电视机有各种颜色）。</p>

<h4 id="4-compatibility-transform">4. Compatibility Transform</h4>

\[Q_i(l) \leftarrow \sum _{l' \in \mathcal L}\mu (l,l')Q_i(l)\]

<ul>
  <li>\(\mu (l,l')\)：两个标签之间的compatibility
    <ul>
      <li>如果相似像素标签不同就有 penalty。Intuitively,不同的 label pair 有不同的penalty会合理一些。</li>
    </ul>
  </li>
  <li>同样可看作是<strong>卷积</strong>操作，且输入输出都有\(L\)个channel，学习filter的参数就是在学习函数\(\mu(.,.)\)</li>
</ul>

<p>至此完成了构造\(\varphi_p(x_i,x_j)\)的任务。</p>

<h4 id="5-unary-compatibility-transform">5. unary-compatibility transform</h4>

<p>计算\(E(\mathbf x)\)：</p>

\[Q_i(l) \leftarrow U_i(l)-Q_i(l)\]

<ul>
  <li>未引入其他参数，误差直接传递给两个输入，注意符号</li>
</ul>

<h4 id="6-normalizationsoftmax">6. Normalization：softmax</h4>

<table>
  <tbody>
    <tr>
      <td>计算$$P(\mathbf X=\mathbf x</td>
      <td>\mathbf I)$$：</td>
    </tr>
  </tbody>
</table>

\[Q_i(l) \leftarrow \frac 1{Z_i}\exp (Q_i(l))\]

<ul>
  <li>softmax的反向传播</li>
</ul>

<hr />

<h3 id="iterable-mean-field--rnn">Iterable Mean-field = RNN</h3>

<ul>
  <li>\(Q_{in}\)：an estimation marginal probability from the previous iteration:</li>
</ul>

\[f_{\theta}(U,Q_{in},I) \\
\theta=\{\omega^{(m)},\mu(l,l')\},\\
m\in \{1,\dots,M\},l,l' \in \{l_1,\dots,l_L\}\]

<p>迭代结构等同于RNN，假设迭代T次：</p>

<ul>
  <li>t=0,使用softmax（U）来初始化</li>
  <li>t&gt;1,每轮$f_{\theta}$中的$Q_{in}$为上一轮输出</li>
  <li>输出$Y$</li>
  <li>学习算法：BP through time
    <ul>
      <li>
        <dl>
          <dt>5次迭代即可收敛，再增加可能导致vanishing和exploding gradient problems。</dt>
          <dd>实现Bilateral filter 的bilateral_lattices_和实现Spatial filter的spatial_lattice</dd>
        </dl>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="3-caffe上的实现">3. Caffe上的实现</h2>

<p>Caffe 是由伯克利大学视觉和学习中心开发的一种深度学习框架。在视觉任务和卷积神经网络模型中，Caffe 格外受欢迎且性能优异。</p>

<p>输入图像：</p>

<p>\(x=\{x_1,\dots,x_P\}\)
$P$为像素数。</p>

<p>目标输出：</p>

\[y=\{y_1,\dots,y_B\},y_i \in L=\{l_1,l_2,\dots,l_L\}\]

<p>因为我们判断的是每一方格<strong>是不是</strong>裂缝。因此这里的标签$L$只有两种。$y_i$即为第$i$个方格的标签。</p>

<h3 id="自己写python层作为输入层">自己写Python层作为输入层</h3>

<p>road_layer.py</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>self.x = np.load(os.path.join(CACHE_PATH, 'x_{}.npy'.format(self.split)))
self.y = np.load(os.path.join(CACHE_PATH, 'y_{}.npy'.format(self.split)))
</code></pre></div></div>

<ul>
  <li>setup()是类启动时该做的事情，比如层所需数据的初始化。</li>
  <li>reshape()就是取数据然后把它规范化为四维的矩阵。每次取数据都会调用此函数。</li>
  <li>forward()就是网络的前向运行，这里就是把取到的数据往前传递，因为没有其他运算。
    <ul>
      <li>assign output</li>
      <li>pick next input</li>
    </ul>
  </li>
  <li>backward()就是网络的反馈，data层是没有反馈的，所以这里就直接pass。</li>
</ul>

<h3 id="生成训练网络">生成训练网络</h3>

<p>net.py生成网络结构文件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    n.data, n.label = L.Python(module='road_layer', layer='ROADSegDataLayer',
            ntop=2, param_str=str(pydata_params))

    # the base net
    n.conv1_1, n.relu1_1 = conv_relu(n.data, 32, ks=5)
    n.conv1_2, n.relu1_2 = conv_relu(n.relu1_1, 32, ks=5)
    n.pool1 = max_pool(n.relu1_2)

    n.conv2_1, n.relu2_1 = conv_relu(n.pool1, 64)
    n.conv2_2, n.relu2_2 = conv_relu(n.relu2_1, 64)
    n.pool2 = max_pool(n.relu2_2)

    n.conv3_1, n.relu3_1 = conv_relu(n.pool2, 128)
    n.conv3_2, n.relu3_2 = conv_relu(n.relu3_1, 128)
    n.pool3 = max_pool(n.relu3_2)

    n.conv4_1, n.relu4_1 = conv_relu(n.pool3, 256)
    n.conv4_2, n.relu4_2 = conv_relu(n.relu4_1, 256)
    # n.conv4_3, n.relu4_3 = conv_relu(n.relu4_2, 512)
    n.pool4 = max_pool(n.relu4_2)

    n.conv5_1, n.relu5_1 = conv_relu(n.pool4, 256)
    n.conv5_2, n.relu5_2 = conv_relu(n.relu5_1, 256)
    # n.conv5_3, n.relu5_3 = conv_relu(n.relu5_2, 512)
    n.pool5 = max_pool(n.relu5_2)

    n.score = conv(n.pool5, 1)
    n.loss = L.SigmoidCrossEntropyLoss(n.score, n.label)
    # n.loss = L.MultiStageMeanfield()
</code></pre></div></div>
<p>分别为一次导入的图片个数，channel，heigth ，width。</p>

<h3 id="solver-优化"><a href="https://rowl1ng.gitbooks.io/machine-learning/content/optimizer.html">Solver 优化</a></h3>

<p>此处的SGD指mini-batch gradient descent，关于batch gradient descent, stochastic gradient descent, 以及 mini-batch gradient descent的具体区别就不细说了。现在的SGD一般都指mini-batch gradient descent。
SGD就是每一次迭代计算梯度，然后对参数进行更新，是最常见的优化方法了。
此处主要说下SGD的缺点：（正因为有这些缺点才让这么多大神发展出了后续的各种算法）</p>

<ul>
  <li>选择合适的learning rate比较困难</li>
  <li>对所有的参数更新使用同样的learningrate。对于稀疏数据或者特征，有时我们可能想更新快一些对于不经常出现的特征，对于常出现的特征更新慢一些，这时候SGD就不太能满足要求了</li>
  <li>SGD容易收敛到局部最优，并且容易被困在鞍点</li>
</ul>

<p>损失平面等高线：</p>

<p><img src="http://img.blog.csdn.net/20160824161755284" alt="损失平面等高线" /></p>

<p>在鞍点处的比较：</p>

<p><img src="http://img.blog.csdn.net/20160824161815758" alt="在鞍点处的比较" /></p>

<p>在Deep Learning中，往往loss function是非凸的，没有解析解，我们需要通过优化方法来求解。solver的主要作用就是交替调用前向（forward)算法和后向（backward)算法来更新参数，从而最小化loss，实际上就是一种迭代的优化算法。</p>

<p>到目前的版本，caffe提供了六种优化算法来求解最优参数，在solver配置文件中，通过设置type类型来选择。
  在训练多通道图片时，此处最好需要有一个meanfile参数。.binaryproto</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> train_net: "train.prototxt"
# train_net: "TVG_CRFRNN_new_deploy.prototxt"
test_net: "val.prototxt"
test_iter: 16
test_interval: 500
base_lr: 5e-4
lr_policy: "fixed"
momentum: 0.99
type: "Adam"
weight_decay: 0.0005
display: 100
max_iter: 1000
snapshot: 1000
snapshot_prefix: "snapshot/train"
solver_mode: GPU
</code></pre></div></div>

<p>This parameter indicates how the learning rate should change over time. This value is a quoted string.</p>

<ol>
  <li>Options include:</li>
</ol>

<ul>
  <li>“step” - drop the learning rate in step sizes indicated by the gamma parameter.</li>
  <li>“multistep” - drop the learning rate in step size indicated by the gamma at each specified stepvalue.</li>
  <li>“fixed” - the learning rate does not change.</li>
  <li>“exp” - gamma^iteration</li>
  <li>“poly” -</li>
  <li>“sigmoid” -</li>
</ul>

<h3 id="训练caffemodel">训练caffemodel</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>../CRFasRNN-merge/caffe-master/build/tools/caffe train -solver solver.prototxt

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>solver = caffe.SGDSolver('models/bvlc_reference_caffenet/solver.prototxt')
</code></pre></div></div>

<h3 id="整合crfasrnn">整合crfasrnn</h3>

<p><code class="language-plaintext highlighter-rouge">net.params</code> : a vector of blobs for <strong>weight</strong> and <strong>bias</strong> parameters</p>

<p><code class="language-plaintext highlighter-rouge">net.params['conv1_1'][0]</code> contains the weight parameters, an array of shape (32, 1, 5, 5) net.params<a href="http://blog.csdn.net/xuanwu_yan/article/details/7962508">‘conv’</a> contains the bias parameters, an array of shape (3,)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>solver = caffe.SGDSolver('solver.prototxt')
solver.net.copy_from('pretrained_param_file')
[...]

## control layer's initialization
halt_training = False
for layer in solver.net.params.keys():
  for index in range(0, 2):
    if len(solver.net.params[layer]) &lt; index+1:
      continue

    if np.sum(solver.net.params[layer][index].data) == 0:
      print layer + ' is composed of zeros!'
      halt_training = True

if halt_training:
  print 'Exiting.'
  exit()
</code></pre></div></div>

<p>To launch <strong>one step</strong> of the gradient descent, that is a forward propagation, a backward propagation and the update of the net params given the gradients (update of the net.params[k][j].data) :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>solver.step(1)
</code></pre></div></div>

<h3 id="multistagemeanfieldlayer">MultiStageMeanfieldLayer</h3>

<h2 id="4-细节">4. 细节</h2>

<h3 id="loss-function">Loss Function</h3>

<ul>
  <li>训练时迭代5，测试时迭代10</li>
  <li>Loss function：
    <ul>
      <li>训练时：log likelihood</li>
      <li>测试时：average IU</li>
    </ul>
  </li>
</ul>

<p>average intersection over union(IU)</p>

<h3 id="normalization-techniques">Normalization techniques</h3>

<p>rectified linear unit (ReLU)</p>

<h2 id="5-环境搭建">5. 环境搭建</h2>

<p>安装python依赖库：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    sudo pip install -r requirements.txt
</code></pre></div></div>

<h3 id="测试">测试</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    #!/bin/bash

    TOOLS=../../caffe/build/tools
    WEIGHTS=TVG_CRFRNN_COCO_VOC.caffemodel
    SOLVER=TVG_CRFRNN_new_solver.prototxt

    $TOOLS/caffe train -solver $SOLVER -weights $WEIGHTS -gpu 0
</code></pre></div></div>

<h3 id="debug">Debug</h3>

<ol>
  <li>cuda</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    libcudart.so.7.0: cannot open shared object file: No such file or directory
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    sudo ldconfig /usr/local/cuda-7.5/lib64
</code></pre></div></div>

<ol>
  <li>Python</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Unknown layer type: Python (known types: AbsVal, Accuracy, ArgMax, BNLL, Concat, ContrastiveLoss, Convolution, Crop, Data, Deconvolution, Dropout, DummyData, Eltwise, Embed, EuclideanLoss, Exp, Filter, Flatten, HDF5Data, HDF5Output, HingeLoss, Im2col, ImageData, InfogainLoss, InnerProduct, LRN, Log, MVN, MemoryData, MultiStageMeanfield, MultinomialLogisticLoss, PReLU, Pooling, Power, ReLU, Reduction, Reshape, SPP, Sigmoid, SigmoidCrossEntropyLoss, Silence, Slice, Softmax, SoftmaxWithLoss, Split, TanH, Threshold, Tile, WindowData)
</code></pre></div></div>

<p>修改Makefile.config</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WITH_PYTHON_LAYER := 1
</code></pre></div></div>

<p>重新make caffe</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm -rf ./build/*
make all -j8
</code></pre></div></div>

<p>8 is the number of parallel threads for compilation (a good choice for the number of threads is the number of cores in your machine).</p>

<p>2.1 build errors:undefined cv::imread() cv::imencode() …</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmake
</code></pre></div></div>

<h2 id="6-related-work">6. Related Work</h2>

<ul>
  <li>
    <p>《<em>Efficient Inference in Fully Connected CRFs with Gaussian Edge Potentials</em>》</p>

  </li>
</ul>


                <p class="post-info">
                    本文由 <a href="/">Rowl1ng</a> 创作，采用 <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">知识共享署名4.0</a> 国际许可协议进行许可<br>本站文章除注明转载/出处外，均为本站原创或翻译，转载前请务必署名<br>本文会经常更新，最后编辑时间为:2015-10-18 11:12:00
                </p>

            </div>

            <div id="container"></div>

            <head>
<!-- <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script> -->
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>

</head>
<body>
<div id="comment"></div>
<script>
    new Valine({
        el:'#comment',
        appId:'idSgAyfHquCiszy8RhbdG3OA-MdYXbMMI',
        appKey:'3gBNM2wIUvW3rj940DTGckvX',
        notify:false,
        verify:false,
        placeholder:'在这里写评论'
    })
</script>
</body>
        </article>

        <footer class="footer bg-white">
    <div class="footer-social">
        <div class="footer-container clearfix">
            <div class="social-list">
                <!--<a class="social segmentfault" target="blank" href="https://segmentfault.com/u/rowl1ng" title="访问 LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>-->
                <a class="social github" target="blank" href="https://github.com/rowl1ng" title="访问 Rowl1ng_Github" data-hover="GitHub">GitHub</a>
                <a class="social deviantart" target="blank" href="https://sixijinling.deviantart.com/" title="访问 Rowl1ng_deviantart" data-hover="deviantart">Deviantart</a>
                <a class="social bilibili" target="blank" href="https://space.bilibili.com/3556743/#!/index" title="访问 Rowl1ng_bilibili" data-hover="bilibili">bilibili</a>
                <!--<a class="social twitter" target="blank" href="http://twitter.com/rowl1ng" title="访问 LiberXue_Twitter" data-hover="Twitter">Twitter</a>-->
                <!--<a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/rowl1ng" title="访问 LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>-->
                <a class="social douban" target="blank" href="https://www.douban.com/people/rowl1ng/" title="访问 Rowl1ng_douban" data-hover="douban">douban</a>
                <a class="social rss" target="blank" href="/feed.xml"title="访问 Rowl1ng_RSS" data-hover="RSS">RSS</a>
            </div>
        </div>
    </div>
    <div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                        <img src="/blog/style/images/logo-rowl1ng.png"   title="访问 Rowl1ng_blog" data-hover="Rowl1ng_blog" alt="Rowl1ng_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://rowl1ng.com/2017/08/03/Jekyllthemes.html" title="访问 Jekyll Rowl1ng主题"  data-hover="Jekyll Rowl1ng"target="_blank">Jekyll rowl1ng</a> by <a href="http://rowl1ng.com/about" target="_blank">Rowl1ng</a></p>
                        <p>Powered by <a href="/blog/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2024 <a href="/feed.xml"  title="访问 Rowl1ng blog RSS" data-hover="Rowl1ng blog RSS">Rowl1ng blog RSS</a></p>
                        <p>
                            <span id="busuanzi_container_site_uv" style="display: inline">
                           本站 UV <a href="http://ibruce.info" target="_blank"><span id="busuanzi_value_site_uv"></span></a>
                            </span>
                            本站 PV <span id="busuanzi_container_site_pv" style="display: inline"></span>
                                <span id="busuanzi_value_site_pv"></span>
                        </p>
                        <!--<p>总计文章：篇</p>-->
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">置顶文章</h3>
                <!--置顶-->
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <li><a href=" /blog/tech/Sketch-VR.html" title="访问 Sketch VR Development Log" data-hover="Sketch VR Development Log">Sketch VR Development Log</a></li>
                
                
                
                
                
                
                
                <li><a href=" /blog/tech/faster-rcnn.html" title="访问 Detectron代码分析：从Faster R-CNN 到 Mask R-CNN" data-hover="Detectron代码分析：从Faster R-CNN 到 Mask R-CNN">Detectron代码分析：从Faster R-CNN 到 Mask R-CNN</a></li>
                
                
                
                
                
                
                
                
                
                <li><a href=" /blog/tech/chatbot.html" title="访问 基于Rasa_NLU的微信chatbot" data-hover="基于Rasa_NLU的微信chatbot">基于Rasa_NLU的微信chatbot</a></li>
                
                
                <!--置顶-->
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">最新文章</h3>
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                
                <!---->
                    <li><a href=" /blog/book/English.html" title="访问 各种英语考试的经验" data-hover="各种英语考试的经验">各种英语考试的经验</a></li>
                <!---->
                
                <!---->
                
            </div>
        </div>
    </div>
</footer>
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script src="/blog/search/js/cb-search.js"></script>
<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
        <div id="directory-content" class="directory-content">
            <div id="directory" class="js-toc"></div>
        </div>

        <!-- <div id="directory-content" class="directory-content">
            <div id="directory"></div>
        </div> -->
        <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
        <script >lang=hljs.initHighlightingOnLoad();</script>
        
        <!--<script type="text/javascript" async-->
                <!--src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">-->
        <!--</script>-->
        <script type="text/javascript" async
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>
        
        <script>
            
            tocbot.init({
            // Where to render the table of contents.
            tocSelector: '.js-toc',
            // Where to grab the headings to build the table of contents.
            contentSelector: '.post-content',
            // Which headings to grab inside of the contentSelector element.
            headingSelector: 'h1, h2, h3',
            // For headings inside relative or absolute positioned containers within content.
            hasInnerContainers: false,
            fixedSidebarOffset: 'auto',
            // headingsOffset: 40,
            scrollSmooth: true,
            scrollSmoothOffset: 0
            });
        </script>
    </body>
</html>