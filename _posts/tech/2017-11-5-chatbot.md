---
layout: blog
tech: true
background-image: http://static.zybuluo.com/sixijinling/an3ms22v79lqj34nkolbbihi/chatbot.png
title:  "基于Rasa_NLU的微信chatbot"
date:   2017-11-05
category: 技术
tags:
- chatbot
- NLP
excerpt: "关于思考快于慢个人读后感和记录"
---


![聊天机器人系统框图][1]

参考[浅谈垂直领域的chatbot][2]：

- 老式chatbot基于大量规则库，不好维护。
- 主流架构为”NLU自然语言理解+DM对话管理+NLG自然语言生成”。
    - NLU负责基础自然语言处理，主要目标是**意图识别**与**实体识别**；
    - DM负责**对话状态维护**、**数据库查询**等；
    - NLG负责生成**交互的自然语言**。
- 机器学习尤其是深度学习在不断改进NLU、DM和NLG，乃至对整个架构的颠覆。
    - 每一个模块都换成DL模型，甚至再加入User Simulator做强化学习，进行端到端的训练
    - Memory Networks：将整个知识库都encode在一个复杂的深度网络中，然后再和encode过的问题结合起来decode生成答案。这个工作最多还是应用在机器阅读理解上，在垂直领域任务导向的chatbot上的成功应用还有待观察。

```python
input_string=""#输入

intent_object=intent(input_string)#意图识别

response=policy(intent_object)#回复生成

print(response)#返回用户
```

### 实验
[中国移动常见问题][3]
## NLU

自然语言理解(NLU)模块，主要是对用户的问题在句子级别进行分类，明确意图识别(Intent Classification)；同时在词级别找出用户问题中的关键实体，进行实体槽填充(Slot Filling)。一个简单的例子，用户问“我想吃羊肉泡馍”，NLU模块就可以识别出用户的意图是“寻找餐馆”，而关键实体是“羊肉泡馍”。有了意图和关键实体，就方便了后面对话管理模块进行后端数据库的查询或是有缺失信息而来继续多轮对话补全其它缺失的实体槽。

[基于中文的Rasa NLU][4]
[用Rasa NLU构建自己的中文NLU系统][5]

> MITIE+Jieba+sklearn (sample_configs/config_jieba_mitie_sklearn.json):

> [“nlp_mitie”, “tokenizer_jieba”, “ner_mitie”, “ner_synonyms”, “intent_featurizer_mitie”, “intent_classifier_sklearn”]

这里也可以看到Rasa NLU的工作流程。”nlp_mitie”初始化MITIE，”tokenizer_jieba”用jieba来做分词，”ner_mitie”和”ner_synonyms”做实体识别，”intent_featurizer_mitie”为意图识别做特征提取，”intent_classifier_sklearn”使用sklearn做意图识别的分类。
> $ curl -XPOST localhost:5000/parse -d '{"q":"I am looking for Chinese food"}' | python -mjson.tool

### Examples
可视化编辑语料[rasa-nlu-trainer][6]
Entities are specified with a start and end value, which together make a python style range to apply to the string, e.g. in the example below, with `text="show me chinese restaurants"`, then `text[8:15] == 'chinese'`. Entities can span multiple words, and in fact the value field does not have to correspond exactly to the substring in your example. That way you can **map syonyms, or misspellings, to the same value**.

也支持markdown训练语料

### MITIE
For MITIE models this is just a score, which might be greater than 1.
You can use this to do some error handling in your chatbot (ex: asking the user again if the confidence is low) and it’s also helpful for prioritising which intents need more training data.

## Rasa Core

安装：
```
pip install rasa_core
git clone https://github.com/RasaHQ/rasa_core.git
cd rasa_core
pip install -r requirements.txt
python setup.py install
```
运行helloworld示例来检验是否正常安装成功：
```
python examples/hello_world/run.py
Bot loaded. Type hello and press enter :
hello
hey there!
```
### 定义领域、意图和动作

```
#创建文件common_domain.yml，复制如下代码
intents:#定义意图
 - greet
 - goodbye
 - chat

entities:
 - action

templates:#表示对于相应的意图采取什么样的回复
  utter_greet:
    - "hello!"
  utter_goodbye:
    - "byebye :("
  utter_chat:
    - "It seems like funny!"

actions:
  - utter_greet
  - utter_goodbye
  - utter_chat
```
### 实现会话逻辑

```
from __future__ import absolute_import
from __future__ import division
from __future__ import print_function
from __future__ import unicode_literals

import logging

import numpy as np

from rasa_core import utils
from rasa_core.actions.action import ACTION_LISTEN_NAME
from rasa_core.agent import Agent
from rasa_core.channels.console import ConsoleInputChannel
from rasa_core.domain import TemplateDomain
from rasa_core.interpreter import NaturalLanguageInterpreter
from rasa_core.policies import Policy
from rasa_core.tracker_store import InMemoryTrackerStore

logger = logging.getLogger(__name__)

class CommonPolicy(Policy):
    def predict_action_probabilities(self, tracker, domain):
        # type: (DialogueStateTracker, Domain) -> List[float]
    #将对应的意图与动作绑定
        responses = {
            "greet": 2,
            "goodbye": 3,
            "chat": 4,
        }

        if tracker.latest_action_name == ACTION_LISTEN_NAME:
            key = tracker.latest_message.intent["name"]
            action = responses[key] if key in responses else 4
            return utils.one_hot(action, domain.num_actions)
        else:
            return np.zeros(domain.num_actions)


class HelloInterpreter(NaturalLanguageInterpreter):
    def parse(self, message):
        # intent = "greet" if 'hello' in message else "default"
        global intent
    #进行意图识别
        if 'hello' in message:
            intent='greet'
        elif 'goodbye' in message:
            intent='goodbye'
        else:
            intent='chat'
        return {
            "text": message,
            "intent": {"name": intent, "confidence": 1.0},
            "entities": []
        }


def run_hello_world(serve_forever=True):
    default_domain = TemplateDomain.load("./common_domain.yml")#加载多个domain怎么办
    agent = Agent(default_domain,
                  policies=[CommonPolicy()],
                  interpreter=HelloInterpreter(),
                  tracker_store=InMemoryTrackerStore(default_domain))

    if serve_forever:
        # Attach the commandline input to the controller to handle all
        # incoming messages from that channel
        agent.handle_channel(ConsoleInputChannel())

    return agent


if __name__ == '__main__':
    run_hello_world()
```

`slots`：用来跟踪上下稳和多轮对话的关键信息。[slot types][7]

![此处输入图片的描述][8]


  [1]: http://img.blog.csdn.net/20171014122725452?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYW5kcm9pZF9ydWJlbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast
  [2]: https://zhuanlan.zhihu.com/p/29757034
  [3]: https://wenku.baidu.com/view/f20fee92daef5ef7ba0d3cf8.html?from=search
  [4]: https://github.com/crownpku/rasa_nlu_chi
  [5]: http://www.crownpku.com/2017/07/27/%E7%94%A8Rasa_NLU%E6%9E%84%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E4%B8%AD%E6%96%87NLU%E7%B3%BB%E7%BB%9F.html
  [6]: https://github.com/RasaHQ/rasa-nlu-trainer
  [7]: https://core.rasa.ai/domains.html#slot-types
  [8]: https://core.rasa.ai/_images/intro_1.png